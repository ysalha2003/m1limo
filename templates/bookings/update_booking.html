{% extends "base.html" %}

{% block title %}Edit Reservation - M1 Limousine Service{% endblock %}

{% block content %}
<div class="card" style="max-width: 900px; margin: 0 auto;">
    <div class="card-header">
        <h1 class="card-title">
            Edit Reservation  #{{ booking.id }}
            {% if trip_role == 'outbound' %}
                <span style="color: #2563eb; font-size: 16px; font-weight: 600; margin-left: 12px;">(Outbound Trip)</span>
            {% elif trip_role == 'return' %}
                <span style="color: #7c3aed; font-size: 16px; font-weight: 600; margin-left: 12px;">(Return Trip)</span>
            {% endif %}
        </h1>
        <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px; flex-wrap: wrap;">
            <span class="badge badge-{{ booking.status|lower }}">{{ booking.get_status_display }}</span>
            <span style="color: #64748b; font-size: 14px;">Created {{ booking.created_at|date:"M d, Y" }}</span>
            {% if is_single_leg_edit and linked_booking %}
                <span style="color: #059669; font-size: 13px; font-weight: 600; background: #d1fae5; padding: 4px 10px; border-radius: 6px;">
                    {% if trip_role == 'outbound' %}
                        Part of Round Trip with Return Trip #{{ linked_booking.id }}
                    {% else %}
                        Part of Round Trip with Outbound Trip #{{ linked_booking.id }}
                    {% endif %}
                </span>
            {% endif %}
        </div>
        {% if is_single_leg_edit %}
        <div style="background: #eff6ff; border-left: 4px solid #2563eb; padding: 12px 16px; margin-top: 16px; border-radius: 6px;">
            <p style="color: #1e40af; font-size: 14px; font-weight: 500; margin: 0;">
                <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 6px;" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>
                You are editing ONLY this {{ trip_role }} leg. The {% if trip_role == 'outbound' %}return{% else %}outbound{% endif %} leg (#{{ linked_booking.id }}) will not be affected.
            </p>
        </div>
        {% endif %}
    </div>

    <form method="post" id="bookingForm">
        {% csrf_token %}

        {% if form.errors %}
        <div style="background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
            <div style="display: flex; gap: 12px;">
                <svg style="width: 20px; height: 20px; color: #ef4444; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div style="flex: 1;">
                    <p style="color: #991b1b; font-weight: 600; margin-bottom: 8px;">Please correct the following errors:</p>
                    {% if form.non_field_errors %}
                        {% for error in form.non_field_errors %}
                            <p style="color: #991b1b; font-size: 14px; margin-bottom: 4px;">• {{ error }}</p>
                        {% endfor %}
                    {% endif %}
                    {% for field in form %}
                        {% if field.errors %}
                            {% for error in field.errors %}
                                <p style="color: #991b1b; font-size: 14px; margin-bottom: 4px;">• <strong>{{ field.label }}:</strong> {{ error }}</p>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Passenger Information -->
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 18px; font-weight: 600; color: var(--dark); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--border);">
                Passenger Information
            </h3>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                <div class="form-group">
                    <label class="form-label" for="id_passenger_name">Passenger Name *</label>
                    {{ form.passenger_name }}
                    {% if form.passenger_name.errors %}
                        <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.passenger_name.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="form-label" for="id_phone_number">{{ form.phone_number.label }}</label>
                    {{ form.phone_number }}
                    {% if form.phone_number.errors %}
                        <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.phone_number.errors.0 }}</div>
                    {% endif %}
                    {% if form.phone_number.help_text %}
                        <div style="color: #64748b; font-size: 12px; margin-top: 4px;">{{ form.phone_number.help_text }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="form-label" for="id_passenger_email">{{ form.passenger_email.label }}</label>
                    {{ form.passenger_email }}
                    {% if form.passenger_email.errors %}
                        <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.passenger_email.errors.0 }}</div>
                    {% endif %}
                    {% if form.passenger_email.help_text %}
                        <div style="color: #64748b; font-size: 12px; margin-top: 4px;">{{ form.passenger_email.help_text }}</div>
                    {% endif %}
                    
                    <!-- Notification Preferences -->
                    <div style="margin-top: 12px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <label class="checkbox-label" style="display: flex; align-items: center; cursor: pointer; margin-bottom: 8px;">
                            {{ form.send_passenger_notifications }}
                            <span style="margin-left: 8px; font-size: 14px; font-weight: 500;">Send notifications to passenger</span>
                        </label>
                        <div style="font-size: 12px; color: #64748b; margin-left: 28px;">
                            Passenger will receive booking confirmation, status updates, and pickup reminders
                        </div>
                    </div>
                    
                    <div style="margin-top: 8px; font-size: 12px; color: #64748b;">
                        You will always receive notifications based on your <a href="{% url 'edit_profile' %}" style="color: var(--primary); text-decoration: underline;">Email Preferences</a>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="id_number_of_passengers">Passenger Count *</label>
                    {{ form.number_of_passengers }}
                    {% if form.number_of_passengers.errors %}
                        <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.number_of_passengers.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Trip Details -->
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 18px; font-weight: 600; color: var(--dark); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--border);">
                Trip Details
            </h3>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                <div class="form-group">
                    <label class="form-label" for="id_trip_type">Trip Type *</label>
                    {{ form.trip_type }}
                    {% if form.trip_type.errors %}
                        <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.trip_type.errors.0 }}</div>
                    {% endif %}
                    <div style="color: #64748b; font-size: 12px; margin-top: 4px;">
                        Point: One-way | Round: Return trip | Hourly: By the hour
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="id_vehicle_type">Vehicle Type *</label>
                    {{ form.vehicle_type }}
                    {% if form.vehicle_type.errors %}
                        <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.vehicle_type.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group" id="hoursBookedGroup" style="display: none;">
                    <label class="form-label" for="id_hours_booked">Hours Booked</label>
                    {{ form.hours_booked }}
                    {% if form.hours_booked.errors %}
                        <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.hours_booked.errors.0 }}</div>
                    {% endif %}
                    <div style="color: #64748b; font-size: 12px; margin-top: 4px;">Minimum 3 hours</div>
                </div>
            </div>
        </div>

        <!-- Pickup Information -->
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 18px; font-weight: 600; color: var(--dark); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--border);">
                Pickup Information
            </h3>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label" for="id_pick_up_address">Pick-up Address *</label>
                    {{ form.pick_up_address }}
                    {% if form.pick_up_address.errors %}
                        <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.pick_up_address.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="form-label" for="id_pick_up_date">Pick-up Date *</label>
                    {{ form.pick_up_date }}
                    {% if form.pick_up_date.errors %}
                        <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.pick_up_date.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="form-label" for="id_pick_up_time">Pick-up Time *</label>
                    {{ form.pick_up_time }}
                    {% if form.pick_up_time.errors %}
                        <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.pick_up_time.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="form-label" for="id_flight_number">Flight Number</label>
                    {{ form.flight_number }}
                    {% if form.flight_number.errors %}
                        <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.flight_number.errors.0 }}</div>
                    {% endif %}
                    <div style="color: #64748b; font-size: 12px; margin-top: 4px;">If applicable</div>
                </div>
            </div>

            <div class="form-group" id="dropoffGroup">
                <label class="form-label" for="id_drop_off_address">Drop-off Address</label>
                {{ form.drop_off_address }}
                {% if form.drop_off_address.errors %}
                    <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.drop_off_address.errors.0 }}</div>
                {% endif %}
            </div>
        </div>

        <!-- Return Trip Information (for Round Trip) -->
        <div id="returnTripSection" style="margin-bottom: 32px; display: none;">
            <h3 style="font-size: 18px; font-weight: 600; color: var(--dark); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--border);">
                Return Trip Information
            </h3>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label" for="id_return_pickup_address">Return Pick-up Address</label>
                    {{ form.return_pickup_address }}
                    {% if form.return_pickup_address.errors %}
                        <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.return_pickup_address.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group" style="grid-column: 1 / -1;">
                    <label class="form-label" for="id_return_dropoff_address">Return Drop-off Address</label>
                    {{ form.return_dropoff_address }}
                    {% if form.return_dropoff_address.errors %}
                        <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.return_dropoff_address.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="form-label" for="id_return_date">Return Date</label>
                    {{ form.return_date }}
                    {% if form.return_date.errors %}
                        <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.return_date.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="form-label" for="id_return_time">Return Time</label>
                    {{ form.return_time }}
                    {% if form.return_time.errors %}
                        <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.return_time.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label class="form-label" for="id_return_flight_number">Return Flight Number</label>
                    {{ form.return_flight_number }}
                    {% if form.return_flight_number.errors %}
                        <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.return_flight_number.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="id_return_special_requests">Return Trip Special Requests</label>
                {{ form.return_special_requests }}
                {% if form.return_special_requests.errors %}
                    <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.return_special_requests.errors.0 }}</div>
                {% endif %}
            </div>
        </div>

        <!-- Additional Information -->
        <div style="margin-bottom: 32px;">
            <h3 style="font-size: 18px; font-weight: 600; color: var(--dark); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--border);">
                Additional Information
            </h3>

            <div class="form-group">
                <label class="form-label" for="id_notes">Special Requests / Notes</label>
                {{ form.notes }}
                {% if form.notes.errors %}
                    <div style="color: #ef4444; font-size: 13px; margin-top: 4px;">{{ form.notes.errors.0 }}</div>
                {% endif %}
                <div style="color: #64748b; font-size: 12px; margin-top: 4px;">
                    Any special requirements or preferences
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div style="display: flex; gap: 12px; padding-top: 24px; border-top: 2px solid var(--border);">
            <button type="submit" class="btn btn-primary" style="flex: 1;">
                Update Booking
            </button>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary" style="flex: 1; text-align: center;">
                Cancel
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .form-input, .form-select, .form-textarea {
        background-color: white;
    }

    .form-input:disabled, .form-select:disabled, .form-textarea:disabled {
        background-color: #f1f5f9;
        cursor: not-allowed;
    }

    select.form-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tripTypeField = document.getElementById('id_trip_type');
        const hoursBookedGroup = document.getElementById('hoursBookedGroup');
        const returnTripSection = document.getElementById('returnTripSection');
        const dropoffGroup = document.getElementById('dropoffGroup');

        function updateFormFields() {
            const tripType = tripTypeField.value;

            // Show/hide hours booked for Hourly trips
            if (tripType === 'Hourly') {
                hoursBookedGroup.style.display = 'block';
                dropoffGroup.style.display = 'none';
            } else {
                hoursBookedGroup.style.display = 'none';
                dropoffGroup.style.display = 'block';
            }

            // Show/hide return trip fields for Round trips
            if (tripType === 'Round') {
                returnTripSection.style.display = 'block';
            } else {
                returnTripSection.style.display = 'none';
            }
        }

        // Initialize on page load
        updateFormFields();

        // Update when trip type changes
        tripTypeField.addEventListener('change', updateFormFields);
    });
</script>
{% endblock %}
