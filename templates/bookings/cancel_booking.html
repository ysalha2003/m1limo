{% extends "base.html" %}

{% block title %}Cancel Trip - M1 Limousine Service{% endblock %}

{% block content %}
<div class="card" style="max-width: 700px; margin: 0 auto;">
    <div style="text-align: center; padding: 20px 0;">
        <div style="width: 80px; height: 80px; background: #fee2e2; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
            <svg style="width: 40px; height: 40px; color: #ef4444;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
        </div>

        <h1 class="card-title" style="margin-bottom: 12px;">
            {% if is_round_trip %}Cancel Booking{% else %}Cancel Trip{% endif %}
        </h1>
        <p style="color: #64748b; margin-bottom: 32px;">
            {% if is_round_trip %}
                Choose whether to cancel the entire round trip booking or just this specific trip.
            {% else %}
                Are you sure you want to cancel this trip? This action cannot be undone.
            {% endif %}
        </p>
    </div>

    <!-- Current Trip Details -->
    <div style="background: var(--light); border-radius: 8px; padding: 20px; margin-bottom: 24px;">
        <h3 style="font-size: 16px; font-weight: 600; color: var(--dark); margin-bottom: 16px;">
            {% if booking.trip_label %}{{ booking.trip_label }}{% else %}Trip{% endif %} Details
        </h3>

        <div style="display: grid; gap: 12px;">
            <div style="display: flex; justify-content: space-between;">
                <span style="color: #64748b; font-size: 14px;">Trip ID:</span>
                <span style="font-weight: 500; color: var(--dark);">#{{ booking.id }}</span>
            </div>

            <div style="display: flex; justify-content: space-between;">
                <span style="color: #64748b; font-size: 14px;">Passenger:</span>
                <span style="font-weight: 500; color: var(--dark);">{{ booking.passenger_name }}</span>
            </div>

            <div style="display: flex; justify-content: space-between;">
                <span style="color: #64748b; font-size: 14px;">Phone:</span>
                <span style="font-weight: 500; color: var(--dark);">{{ booking.phone_number }}</span>
            </div>

            <div style="display: flex; justify-content: space-between;">
                <span style="color: #64748b; font-size: 14px;">Pickup:</span>
                <span style="font-weight: 500; color: var(--dark); text-align: right;">{{ booking.pick_up_address }}</span>
            </div>

            <div style="display: flex; justify-content: space-between;">
                <span style="color: #64748b; font-size: 14px;">Date & Time:</span>
                <span style="font-weight: 500; color: var(--dark);">{{ booking.pick_up_date }} at {{ booking.pick_up_time }}</span>
            </div>

            <div style="display: flex; justify-content: space-between;">
                <span style="color: #64748b; font-size: 14px;">Vehicle:</span>
                <span style="font-weight: 500; color: var(--dark);">{{ booking.vehicle_type }}</span>
            </div>

            <div style="display: flex; justify-content: space-between;">
                <span style="color: #64748b; font-size: 14px;">Status:</span>
                <span class="badge badge-{{ booking.status|lower }}">{{ booking.get_status_display }}</span>
            </div>
        </div>
    </div>

    {% if is_round_trip and linked_booking %}
    <!-- Linked Trip Details -->
    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 20px; margin-bottom: 24px;">
        <h3 style="font-size: 16px; font-weight: 600; color: var(--dark); margin-bottom: 16px;">
            {% if linked_booking.trip_label %}{{ linked_booking.trip_label }}{% else %}Linked Trip{% endif %} Details
        </h3>

        <div style="display: grid; gap: 12px;">
            <div style="display: flex; justify-content: space-between;">
                <span style="color: #475569; font-size: 14px;">Trip ID:</span>
                <span style="font-weight: 500; color: var(--dark);">#{{ linked_booking.id }}</span>
            </div>

            <div style="display: flex; justify-content: space-between;">
                <span style="color: #475569; font-size: 14px;">Pickup:</span>
                <span style="font-weight: 500; color: var(--dark); text-align: right;">{{ linked_booking.pick_up_address }}</span>
            </div>

            <div style="display: flex; justify-content: space-between;">
                <span style="color: #475569; font-size: 14px;">Date & Time:</span>
                <span style="font-weight: 500; color: var(--dark);">{{ linked_booking.pick_up_date }} at {{ linked_booking.pick_up_time }}</span>
            </div>

            <div style="display: flex; justify-content: space-between;">
                <span style="color: #475569; font-size: 14px;">Status:</span>
                <span class="badge badge-{{ linked_booking.status|lower }}">{{ linked_booking.get_status_display }}</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Warning Message -->
    <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
        <div style="display: flex; gap: 12px;">
            <svg style="width: 20px; height: 20px; color: #d97706; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div>
                {% if is_admin %}
                <p style="color: #92400e; font-weight: 600; margin-bottom: 4px; font-size: 14px;">Admin Cancellation Notice</p>
                <p style="color: #78350f; font-size: 13px; margin-bottom: 8px;">
                    You are cancelling this booking as an administrator. The customer will be notified of this cancellation.
                </p>
                {% if booking.hours_until_pickup %}
                <p style="color: #78350f; font-size: 13px; margin-bottom: 4px;">
                    <strong>Time until {{ booking.trip_label|default:"this trip" }}:</strong> {{ booking.time_until_pickup_formatted }}
                </p>
                {% with can_cancel_info=booking.can_cancel_formatted %}
                {% if can_cancel_info.1 %}
                <p style="color: #78350f; font-size: 13px;">
                    <strong>Note:</strong> This cancellation is {% if booking.status == 'Confirmed' %}less than 2 hours{% else %}less than 4 hours{% endif %} before pickup. The booking will be marked with full charges.
                </p>
                {% else %}
                <p style="color: #78350f; font-size: 13px;">
                    <strong>Note:</strong> This cancellation is {% if booking.status == 'Confirmed' %}more than 2 hours{% else %}more than 4 hours{% endif %} before pickup. No charges will apply.
                </p>
                {% endif %}
                {% endwith %}
                {% endif %}
                {% else %}
                <p style="color: #92400e; font-weight: 600; margin-bottom: 4px; font-size: 14px;">Cancellation Policy</p>
                <p style="color: #78350f; font-size: 13px; margin-bottom: 8px;">
                    Cancellations of {% if booking.status == 'Confirmed' %}confirmed bookings made less than 2 hours{% else %}pending bookings made less than 4 hours{% endif %} before pickup time will incur full charges.
                </p>
                {% if booking.hours_until_pickup %}
                <p style="color: #78350f; font-size: 13px;">
                    <strong>Time until {{ booking.trip_label|default:"this trip" }}:</strong> {{ booking.time_until_pickup_formatted }}
                </p>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Confirmation Form -->
    <form method="post">
        {% csrf_token %}

        {% if is_round_trip %}
        <!-- Cancellation Options for Round Trip -->
        <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 24px;">
            <h3 style="font-size: 15px; font-weight: 600; color: var(--dark); margin-bottom: 16px;">Cancellation Options</h3>

            <label style="display: block; border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;" class="cancel-option">
                <div style="display: flex; align-items: start; gap: 12px;">
                    <input type="radio" name="cancel_type" value="entire" checked style="margin-top: 4px;">
                    <div>
                        <div style="font-weight: 600; color: var(--dark); margin-bottom: 4px;">Cancel Entire Round Trip Booking</div>
                        <div style="font-size: 13px; color: #64748b;">Cancel both trips: #{{ booking.id }} and #{{ linked_booking.id }} (recommended)</div>
                    </div>
                </div>
            </label>

            <label style="display: block; border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s;" class="cancel-option">
                <div style="display: flex; align-items: start; gap: 12px;">
                    <input type="radio" name="cancel_type" value="single" style="margin-top: 4px;">
                    <div>
                        <div style="font-weight: 600; color: var(--dark); margin-bottom: 4px;">Cancel Only Trip #{{ booking.id }} ({{ booking.trip_label|default:"This Trip" }})</div>
                        <div style="font-size: 13px; color: #64748b;">Keep Trip #{{ linked_booking.id }} ({{ linked_booking.trip_label|default:"Other Trip" }}) active</div>
                    </div>
                </div>
            </label>
        </div>
        {% else %}
        <input type="hidden" name="cancel_type" value="single">
        {% endif %}

        <!-- Cancellation Reason -->
        <div style="margin-bottom: 24px;">
            <label style="display: block; font-weight: 600; color: var(--dark); margin-bottom: 8px; font-size: 14px;">
                Reason for Cancellation (Optional)
            </label>
            <textarea
                name="cancellation_reason"
                rows="3"
                style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"
                placeholder="Please let us know why you're cancelling..."
            ></textarea>
        </div>

        <div style="display: flex; gap: 12px;">
            <button type="submit" style="flex: 1; padding: 12px 20px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                {% if is_round_trip %}Confirm Cancellation{% else %}Yes, Cancel Trip{% endif %}
            </button>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary" style="flex: 1; text-align: center; padding: 12px 20px;">
                Go Back
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_css %}
<style>
    button[type="submit"]:hover {
        background: #dc2626;
        box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
    }

    .cancel-option:has(input:checked) {
        border-color: #3b82f6;
        background-color: #eff6ff;
    }

    .cancel-option:hover {
        border-color: #3b82f6;
    }
</style>
{% endblock %}
