{% extends "base.html" %}
{% load booking_filters %}

{% block title %}Dashboard - M1 Limousine Service{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        background: white;
        border-radius: var(--radius-lg);
        padding: 16px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-light);
        transition: var(--transition-slow);
        position: relative;
        overflow: hidden;
        text-decoration: none;
        color: inherit;
        display: block;
        cursor: pointer;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, transparent 0%, var(--border) 50%, transparent 100%);
        opacity: 0;
        transition: var(--transition);
    }

    .stat-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-3px);
        border-color: var(--border);
    }

    .stat-card:hover::before {
        opacity: 1;
    }

    .stat-card.active {
        border-color: var(--primary);
        background: linear-gradient(to bottom, white 0%, rgba(15, 23, 42, 0.02) 100%);
        box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.1);
    }

    .stat-card.active::before {
        opacity: 1;
        background: linear-gradient(90deg, transparent 0%, var(--primary) 50%, transparent 100%);
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-xs);
        position: relative;
    }

    .stat-icon::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: linear-gradient(135deg, rgba(255,255,255,0.8) 0%, transparent 100%);
        pointer-events: none;
    }

    .stat-value {
        font-size: 26px;
        font-weight: 700;
        color: var(--dark);
        line-height: 1;
        letter-spacing: -0.03em;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 12px;
        margin-bottom: 6px;
        font-weight: 600;
        letter-spacing: -0.01em;
    }

    /* PART 3: CSS for cancelled/past trips */
    .trip-cancelled {
        opacity: 0.5;
        background-color: rgba(0, 0, 0, 0.02);
        color: var(--text-muted);
        position: relative;
    }

    .trip-cancelled::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(to bottom, transparent, #6b7280, transparent);
    }

    .trip-cancelled .badge {
        opacity: 0.8;
    }

    .trip-past {
        opacity: 0.5;
        background-color: rgba(0, 0, 0, 0.02);
        color: var(--text-muted);
    }

    .today-pickups-card {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.04) 0%, rgba(51, 65, 85, 0.04) 100%);
        border: 1.5px solid rgba(30, 41, 59, 0.15);
        border-radius: var(--radius-xl);
        padding: 18px;
        margin-bottom: 20px;
        box-shadow: var(--shadow-sm);
        position: relative;
        overflow: hidden;
    }

    .today-pickups-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(to bottom, var(--pending) 0%, var(--accent) 100%);
    }

    .pickup-item {
        background: white;
        border-radius: var(--radius-lg);
        padding: 18px;
        border: 1px solid var(--border-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 14px;
        transition: var(--transition-slow);
        box-shadow: var(--shadow-xs);
    }

    .pickup-item:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--border);
        transform: translateY(-2px);
    }

    .search-form {
        background: linear-gradient(to bottom, white 0%, var(--light) 100%);
        padding: 24px;
        border-radius: var(--radius-lg);
        margin-bottom: 28px;
        border: 1px solid var(--border-light);
        box-shadow: var(--shadow-xs);
    }

    .search-form-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr auto;
        gap: 12px;
        align-items: end;
    }

    .search-form-actions {
        display: flex;
        gap: 8px;
    }

    .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -2px; /* Compensate for potential overflow */
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        table-layout: fixed; /* Fixed layout for consistent column widths */
    }

    /* Column width distribution - adjust based on content importance and size */
    table th:nth-child(1),
    table td:nth-child(1) {
        width: 18%; /* Passenger - needs space for ID, badges, name, contact */
        min-width: 180px;
    }

    /* Customer column (admin only) - adjust selectors when visible */
    .table-wrapper table th:nth-child(2),
    .table-wrapper table td:nth-child(2) {
        width: 14%; /* Customer info */
        min-width: 140px;
    }

    /* Pickup column shifts position based on admin view */
    table th:nth-child(2):not(.hide-mobile),
    table td:nth-child(2):not(.hide-mobile) {
        width: 22%; /* Pickup - addresses need more space */
        min-width: 200px;
    }

    table th:nth-child(3),
    table td:nth-child(3) {
        width: 22%; /* Pickup or Date depending on context */
        min-width: 200px;
    }

    table th:nth-child(4),
    table td:nth-child(4) {
        width: 13%; /* Date & Time */
        min-width: 120px;
    }

    table th:nth-child(5),
    table td:nth-child(5) {
        width: 12%; /* Vehicle or Status */
        min-width: 110px;
    }

    table th:nth-child(6),
    table td:nth-child(6) {
        width: 11%; /* Status or Driver */
        min-width: 100px;
    }

    table th:nth-child(7),
    table td:nth-child(7) {
        width: 13%; /* Driver or Actions */
        min-width: 110px;
    }

    table th:last-child,
    table td:last-child {
        width: 13%; /* Actions - needs space for multiple links */
        min-width: 120px;
    }

    th {
        padding: 14px 12px;
        color: var(--text-secondary);
        font-weight: 600;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid var(--border);
        text-align: left;
        white-space: nowrap;
        background: var(--light);
    }

    td {
        padding: 18px 12px;
        border-bottom: 1px solid var(--border);
        vertical-align: top;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    /* Text overflow handling for addresses and long content */
    td > div {
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Allow multi-line for address fields specifically */
    td > div[style*="font-size: 14px"],
    td > div[style*="font-size: 13px"] {
        white-space: normal;
        line-height: 1.5;
        overflow: visible;
        text-overflow: clip;
    }

    tr:hover {
        background: var(--light);
        transition: background-color var(--transition-fast);
    }

    /* Better hover for non-cancelled/past trips */
    tr:not(.trip-cancelled):not(.trip-past):hover {
        background: var(--light-hover);
    }

    /* Ensure action column content stays compact */
    td:last-child > div {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
    }

    .action-link {
        color: var(--primary);
        text-decoration: none;
        font-weight: 500;
        font-size: 13px;
        transition: var(--transition);
        white-space: nowrap;
    }

    .action-link:hover {
        color: var(--primary-hover);
        text-decoration: underline;
    }

    .round-trip-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 8px;
        background: var(--info-light);
        color: #1e40af;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 700;
        white-space: nowrap;
    }

    .expand-btn {
        color: var(--primary);
        background: none;
        border: none;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        padding: 0;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: var(--transition);
    }

    .expand-btn:hover {
        color: var(--primary-hover);
    }

    .expand-icon {
        width: 14px;
        height: 14px;
        transition: transform 0.2s;
    }

    .return-row {
        background: #f8fafc;
    }

    .return-row td {
        padding: 20px 16px !important; /* Override default td padding for better spacing */
    }

    .return-trip-content {
        border-left: 3px solid var(--primary);
        padding-left: 16px;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }

    .empty-icon {
        width: 80px;
        height: 80px;
        background: var(--light-gray);
        border-radius: 50%;
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    @media (max-width: 1024px) {
        .stat-card {
            padding: 16px;
        }

        .stat-value {
            font-size: 24px;
        }

        /* Adjust table for tablet screens */
        table {
            font-size: 13px;
            table-layout: auto; /* Allow flexible sizing on tablets */
        }

        th, td {
            padding: 12px 10px;
        }

        /* Reduce min-widths for tablet */
        table th, table td {
            min-width: 100px;
        }

        table th:nth-child(1),
        table td:nth-child(1) {
            min-width: 150px;
        }

        table th:last-child,
        table td:last-child {
            min-width: 110px;
        }
    }

    @media (max-width: 768px) {
        .stat-card {
            padding: 14px;
        }

        .stat-icon {
            width: 38px;
            height: 38px;
        }

        .stat-value {
            font-size: 22px;
        }

        .stat-label {
            font-size: 12px;
        }

        .today-pickups-card {
            padding: 16px;
        }

        .pickup-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
            padding: 14px;
        }

        .pickup-actions {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .search-form {
            padding: 16px;
        }

        /* Make search form stack on mobile */
        .search-form .search-form-grid {
            grid-template-columns: 1fr;
        }

        .search-form .form-group {
            width: 100%;
        }

        .search-form-actions {
            flex-direction: row;
            gap: 8px;
            width: 100%;
        }

        .search-form-actions .btn {
            flex: 1;
        }

        /* Mobile table optimizations */
        table {
            font-size: 12px;
            table-layout: auto; /* Allow content to determine width on mobile */
        }

        th {
            padding: 10px 8px;
            font-size: 11px;
        }

        td {
            padding: 14px 8px;
        }

        .action-link {
            font-size: 12px;
        }

        /* Hide less important columns on mobile */
        .hide-mobile {
            display: none !important;
        }

        /* Remaining columns take up available space */
        table th:not(.hide-mobile),
        table td:not(.hide-mobile) {
            min-width: 0;
        }

        /* Key columns for mobile: Passenger, Pickup/Date, Status, Actions */
        table th:nth-child(1),
        table td:nth-child(1) {
            width: 30%; /* Passenger gets more space */
            min-width: 140px;
        }

        table th:nth-child(2):not(.hide-mobile),
        table td:nth-child(2):not(.hide-mobile) {
            width: 30%; /* Pickup or Date */
            min-width: 140px;
        }

        table th:nth-child(3):not(.hide-mobile),
        table td:nth-child(3):not(.hide-mobile) {
            width: 20%; /* Status or Date */
            min-width: 100px;
        }

        table th:last-child,
        table td:last-child {
            width: 20%; /* Actions */
            min-width: 100px;
        }

        /* Improve readability of long text on mobile */
        td > div[style*="font-size: 14px"],
        td > div[style*="font-size: 13px"] {
            font-size: 12px !important;
            line-height: 1.4;
        }
    }

    @media (max-width: 375px) {
        .stat-value {
            font-size: 20px;
        }

        .pickup-item {
            padding: 12px;
        }

        /* Further optimize table for very small screens */
        th {
            padding: 8px 6px;
            font-size: 10px;
        }

        td {
            padding: 12px 6px;
            font-size: 11px;
        }

        /* Compact action links */
        .action-link {
            font-size: 11px;
            white-space: nowrap;
        }

        /* Tighter column widths for smallest screens */
        table th:nth-child(1),
        table td:nth-child(1) {
            min-width: 120px;
        }

        table th:nth-child(2):not(.hide-mobile),
        table td:nth-child(2):not(.hide-mobile) {
            min-width: 120px;
        }
    }

    /* Pulse animation for notification badges */
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.7;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="welcome-banner">
    <h1>{% if is_admin %}Admin Dashboard{% else %}My Dashboard{% endif %}</h1>
    <p>{% if is_admin %}Manage all bookings and operations{% else %}View and manage your bookings{% endif %}</p>
</div>

<!-- Stats Grid -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 32px;">
    <!-- Stat Cards with Semantic Colors:
         - Info (Blue): General information/total counts
         - Warning (Orange): Pending/time-sensitive items
         - Success (Green): Confirmed/successful states
         - Info (Blue): Completed items
    -->
    <a href="{% url 'dashboard' %}" class="stat-card {% if not request.GET.status %}active{% endif %}">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <p class="stat-label">Total Bookings</p>
                <p class="stat-value">{{ stats.total_bookings|default:0 }}</p>
            </div>
            <div class="stat-icon" style="background: linear-gradient(135deg, var(--primary-light) 0%, #e2e8f0 100%);">
                <svg style="width: 24px; height: 24px; color: var(--primary); position: relative; z-index: 1;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
            </div>
        </div>
    </a>

    <a href="?status=Pending" class="stat-card {% if request.GET.status == 'Pending' %}active{% endif %}">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <p class="stat-label">Pending</p>
                <p class="stat-value" style="color: var(--pending);">{{ stats.pending_count|default:0 }}</p>
            </div>
            <div class="stat-icon" style="background: linear-gradient(135deg, var(--pending-light) 0%, #ebf0e2 100%);">
                <svg style="width: 24px; height: 24px; color: var(--pending); position: relative; z-index: 1;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
        </div>
    </a>

    <a href="?status=Confirmed" class="stat-card {% if request.GET.status == 'Confirmed' %}active{% endif %}">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <p class="stat-label">Confirmed</p>
                <p class="stat-value" style="color: var(--success);">{{ stats.confirmed_count|default:0 }}</p>
            </div>
            <div class="stat-icon" style="background: linear-gradient(135deg, var(--success-light) 0%, #a7f3d0 100%);">
                <svg style="width: 24px; height: 24px; color: var(--success); position: relative; z-index: 1;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
        </div>
    </a>

    <a href="?status=Trip_Completed&date=today" class="stat-card {% if request.GET.status == 'Trip_Completed' and request.GET.date == 'today' %}active{% endif %}">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <p class="stat-label">Completed Today</p>
                <p class="stat-value" style="color: var(--info);">{{ stats.completed_today|default:0 }}</p>
            </div>
            <div class="stat-icon" style="background: linear-gradient(135deg, var(--info-light) 0%, #bfdbfe 100%);">
                <svg style="width: 24px; height: 24px; color: var(--info); position: relative; z-index: 1;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
            </div>
        </div>
    </a>
</div>

<!-- Today's Pickups -->
{% if today_pickups %}
<div class="today-pickups-card">
    <div style="display: flex; align-items: center; gap: 14px; margin-bottom: 24px;">
        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--pending) 0%, var(--accent) 100%); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); position: relative;">
            <div style="position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 100%); border-radius: inherit;"></div>
            <svg style="width: 26px; height: 26px; color: white; position: relative; z-index: 1;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
        </div>
        <h2 style="font-size: 19px; font-weight: 700; margin: 0; color: var(--dark); letter-spacing: -0.02em;">Today's Pickups <span style="color: var(--text-secondary); font-weight: 600;">({{ today_pickups|length }})</span></h2>
    </div>

    <div style="display: grid; gap: 12px;">
        {% for booking in today_pickups %}
        <div class="pickup-item">
            <div style="flex: 1; min-width: 0;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px; flex-wrap: wrap;">
                    <span style="font-weight: 700; font-size: 14px; color: var(--dark);">{{ booking.pick_up_time }}</span>
                    <span class="badge badge-{{ booking.status|lower }}">{{ booking.get_status_display }}</span>
                    {% if booking.trip_type == 'Round' and booking.linked_booking %}
                        <span class="round-trip-badge">
                            <svg style="width: 10px; height: 10px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                            </svg>
                            ROUND
                        </span>
                    {% endif %}
                </div>
                <div style="font-weight: 600; color: var(--dark); margin-bottom: 4px;">
                    {{ booking.passenger_name }}
                    {% if booking.trip_label %}
                        <span style="font-size: 12px; color: var(--text-secondary); font-weight: 500; margin-left: 8px;">({{ booking.trip_label }})</span>
                    {% endif %}
                </div>
                <div style="font-size: 14px; color: var(--text-secondary);"> {{ booking.pick_up_address }}</div>
                {% if booking.drop_off_address %}
                <div style="font-size: 14px; color: var(--text-secondary);">→ {{ booking.drop_off_address }}</div>
                {% endif %}
                <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">{{ booking.vehicle_type }} • {{ booking.phone_number|default:booking.passenger_email }}</div>
            </div>
            <div class="pickup-actions">
                {% if is_admin and booking.status == 'Confirmed' %}
                    {% if booking.hours_until_pickup <= 0 %}
                        <a href="{% url 'booking_actions' booking.id 'complete' %}" class="btn btn-secondary" style="font-size: 13px; padding: 8px 14px;">✓ Complete</a>
                    {% else %}
                        <span class="btn btn-secondary" style="font-size: 13px; padding: 8px 14px; opacity: 0.5; cursor: not-allowed; pointer-events: none;" title="Cannot complete until after pickup time ({{ booking.time_until_pickup_formatted }} remaining)">✓ Complete</span>
                    {% endif %}
                {% endif %}
                <a href="{% url 'booking_detail' booking.id %}" class="btn btn-secondary" style="font-size: 13px; padding: 8px 14px;">View</a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Bookings List -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
        <h2 style="font-size: 18px; font-weight: 700; margin: 0; color: var(--dark);">
            {% if is_admin %}All Bookings{% else %}Your Bookings{% endif %}
        </h2>
        <a href="{% url 'new_booking' %}" class="btn btn-primary">+ New Booking</a>
    </div>

    <!-- Search & Filter -->
    <form method="get" class="search-form">
        <div class="search-form-grid">
            <div class="form-group" style="margin: 0;">
                <label class="form-label">Search</label>
                <input type="text" name="search" class="form-input" placeholder="Booking ID, Name, Phone, or Reference Number" value="{{ request.GET.search }}" style="margin: 0;">
            </div>

            <div class="form-group" style="margin: 0;">
                <label class="form-label">Date</label>
                <input type="date" name="date" class="form-input" value="{{ request.GET.date }}" style="margin: 0;">
            </div>

            <div class="form-group" style="margin: 0;">
                <label class="form-label">Status</label>
                <select name="status" class="form-select" style="margin: 0;">
                    <option value="">All States</option>
                    <option value="Pending" {% if request.GET.status == 'Pending' %}selected{% endif %}>Pending</option>
                    <option value="Confirmed" {% if request.GET.status == 'Confirmed' %}selected{% endif %}>Confirmed</option>
                    <option value="Trip_Completed" {% if request.GET.status == 'Trip_Completed' %}selected{% endif %}>Completed</option>
                    <option value="Cancelled" {% if request.GET.status == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
            </div>

            <div class="search-form-actions">
                <button type="submit" class="btn btn-primary" style="margin: 0;">Search</button>
                <a href="{% url 'dashboard' %}" class="btn btn-secondary" style="margin: 0;">Clear</a>
            </div>
        </div>

        {% if request.GET.search or request.GET.date or request.GET.status %}
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: space-between;">
                <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                    <span style="font-size: 13px; color: var(--text-secondary); font-weight: 600;">Active Filters:</span>
                    {% if request.GET.search %}
                    <span class="badge" style="background: var(--info-light); color: #1e40af;">Search: "{{ request.GET.search }}"</span>
                    {% endif %}
                    {% if request.GET.date %}
                    <span class="badge" style="background: var(--info-light); color: #1e40af;">Date: {{ request.GET.date }}</span>
                    {% endif %}
                    {% if request.GET.status %}
                    <span class="badge" style="background: var(--info-light); color: #1e40af;">Status: {{ request.GET.status }}</span>
                    {% endif %}
                </div>
                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: linear-gradient(135deg, var(--primary-light) 0%, #e2e8f0 100%); border-radius: 6px; border: 1px solid var(--border);">
                    <svg style="width: 16px; height: 16px; color: var(--primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    <span style="font-size: 13px; color: var(--dark); font-weight: 700;">{{ display_count }} {% if display_count == 1 %}trip{% else %}trips{% endif %}</span>
                </div>
            </div>
        </div>
        {% endif %}
    </form>

    {% if bookings %}
        <!-- Trip Count Display (shown even without filters) -->
        {% if not request.GET.search and not request.GET.date and not request.GET.status %}
        <div style="margin-bottom: 16px; display: flex; justify-content: flex-end;">
            <div style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: linear-gradient(135deg, var(--primary-light) 0%, #e2e8f0 100%); border-radius: 6px; border: 1px solid var(--border);">
                <svg style="width: 16px; height: 16px; color: var(--primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <span style="font-size: 13px; color: var(--dark); font-weight: 700;">Total: {{ display_count }} {% if display_count == 1 %}trip{% else %}trips{% endif %}</span>
            </div>
        </div>
        {% endif %}
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Passenger</th>
                        {% if is_admin %}<th class="hide-mobile">Customer</th>{% endif %}
                        <th>Pickup</th>
                        <th>Date & Time</th>
                        <th class="hide-mobile">Vehicle</th>
                        <th>Status</th>
                        {% if is_admin %}<th class="hide-mobile">Driver</th>{% endif %}
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in bookings %}
                    <tr class="booking-row-{{ booking.id }} {% if booking.status == 'Cancelled' or booking.status == 'Cancelled_Full_Charge' %}trip-cancelled{% elif booking.is_past_trip %}trip-past{% endif %}">
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-size: 11px; font-weight: 700; color: var(--primary); background: var(--primary-light); padding: 2px 6px; border-radius: 4px;">ID #{{ booking.id }}</span>
                                {% if not is_admin and booking.has_unviewed_changes %}
                                    <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 10px; font-weight: 700; color: #dc2626; background: #fee2e2; padding: 2px 6px; border-radius: 4px; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;" title="Recent activity - status updated">
                                        <svg style="width: 10px; height: 10px;" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                                        </svg>
                                        NEW
                                    </span>
                                {% endif %}
                                {% if booking.trip_type == 'Round' and booking.linked_booking %}
                                    <span class="round-trip-badge">
                                        <svg style="width: 12px; height: 12px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                                        </svg>
                                        ROUND
                                    </span>
                                {% endif %}
                            </div>
                            <div style="font-weight: 600; color: var(--dark);">
                                {{ booking.passenger_name }}
                                {% if booking.is_past_trip %}
                                    <span style="font-size: 11px; color: var(--text-muted); font-weight: 500; margin-left: 6px;">(Past Trip)</span>
                                {% endif %}
                                {% if booking.trip_label %}
                                    <span style="font-size: 11px; color: var(--text-secondary); font-weight: 500; margin-left: 6px;">({{ booking.trip_label }})</span>
                                {% endif %}
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary);">{{ booking.phone_number|default:booking.passenger_email }}</div>
                            {% if booking.booking_reference %}
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">{{ booking.booking_reference }}</div>
                            {% endif %}
                        </td>
                        {% if is_admin %}
                        <td class="hide-mobile">
                            <div style="font-weight: 500; color: var(--dark);">{{ booking.user.username }}</div>
                            {% if booking.user.profile.company_name %}
                            <div style="font-size: 12px; color: var(--primary); font-weight: 600; margin-top: 2px;">
                                <svg style="width: 12px; height: 12px; display: inline-block; vertical-align: middle; margin-right: 3px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>{{ booking.user.profile.company_name }}
                            </div>
                            {% endif %}
                            <div style="font-size: 13px; color: var(--text-secondary);">{{ booking.user.email|default:"No email" }}</div>
                        </td>
                        {% endif %}
                        <td>
                            <div style="font-size: 14px; color: var(--dark);">{{ booking.pick_up_address }}</div>
                            {% if booking.drop_off_address %}
                            <div style="font-size: 13px; color: var(--text-secondary);">→ {{ booking.drop_off_address }}</div>
                            {% endif %}
                        </td>
                        <td>
                            <div style="font-weight: 500;">{{ booking.pick_up_date }}</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">{{ booking.pick_up_time }}</div>
                            {% if booking.hours_until_pickup > 0 and booking.hours_until_pickup <= 24 and booking.status in 'Pending,Confirmed' %}
                            <div style="font-size: 11px; color: var(--warning); font-weight: 600; margin-top: 4px;">
                                {{ booking.time_until_pickup_formatted }} away
                            </div>
                            {% endif %}
                        </td>
                        <td class="hide-mobile">
                            <div>{{ booking.vehicle_type }}</div>
                            <div style="font-size: 13px; color: var(--text-secondary);">{{ booking.get_trip_type_display }}</div>
                        </td>
                        <td>
                            <span class="badge badge-{{ booking.status|lower }}">{{ booking.get_status_display }}</span>
                        </td>
                        {% if is_admin %}
                        <td class="hide-mobile">
                            {% if booking.assigned_driver %}
                                <div style="font-weight: 500; color: var(--dark);">{{ booking.assigned_driver.full_name }}</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">
                                    {% if booking.driver_response_status == 'accepted' %}
                                        <span style="color: #059669;">✓ Accepted</span>
                                    {% elif booking.driver_response_status == 'rejected' %}
                                        <span style="color: #dc2626;">✗ Rejected</span>
                                    {% elif booking.driver_response_status == 'completed' %}
                                        <span style="color: #0c5460;">✓ Completed</span>
                                    {% endif %}
                                </div>
                            {% else %}
                                <span style="color: var(--text-muted); font-size: 13px;">Driver Not Assigned</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        <td>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                {% if booking.is_past_trip %}
                                    {# Past trips: Only show View and Rebook #}
                                    <a href="{% url 'booking_detail' booking.id %}" class="action-link">View</a>
                                    <a href="{% url 'rebook_booking' booking.id %}" class="action-link" style="color: var(--primary); font-weight: 600;">
                                        <svg style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 2px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                        </svg>
                                        Rebook
                                    </a>
                                {% else %}
                                    {# Active trips: Normal actions #}
                                    {% if booking.trip_type == 'Round' and booking.linked_booking %}
                                        <button onclick="toggleReturn({{ booking.id }})" class="expand-btn expand-btn-{{ booking.id }}">
                                            <svg class="expand-icon expand-icon-{{ booking.id }}" style="transform: rotate(180deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                            </svg>
                                            Hide Return
                                        </button>
                                    {% endif %}
                                    <a href="{% url 'booking_detail' booking.id %}" class="action-link">View</a>
                                    {% if is_admin %}
                                        {% if booking.status == 'Pending' %}
                                            <a href="{% url 'booking_actions' booking.id 'confirm' %}" class="action-link" style="color: var(--success);">✓ Approve</a>
                                        {% elif booking.status == 'Confirmed' %}
                                            {% if booking.hours_until_pickup <= 0 %}
                                                <a href="{% url 'booking_actions' booking.id 'complete' %}" class="action-link" style="color: var(--primary);">✓ Complete</a>
                                            {% else %}
                                                <span class="action-link" style="color: var(--text-muted); opacity: 0.5; cursor: not-allowed; pointer-events: none;" title="Cannot complete until after pickup time ({{ booking.time_until_pickup_formatted }} remaining)">✓ Complete</span>
                                            {% endif %}
                                        {% endif %}
                                    {% else %}
                                        {% if booking.status in 'Pending,Confirmed' and booking.hours_until_pickup > 2 %}
                                            {% if booking.trip_type == 'Round' %}
                                                <a href="{% url 'update_booking' booking.id %}" class="action-link">Edit Outbound</a>
                                            {% else %}
                                                <a href="{% url 'update_booking' booking.id %}" class="action-link">Edit</a>
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>

                    {% if booking.trip_type == 'Round' and booking.linked_booking %}
                    <tr class="return-row return-row-{{ booking.id }}" style="display: table-row;">
                        <td colspan="{% if is_admin %}8{% else %}6{% endif %}" style="padding: 16px 24px;">
                            <div class="return-trip-content">
                                <div style="font-weight: 600; color: var(--primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                                    </svg>
                                    Return Trip
                                    <span style="font-size: 11px; font-weight: 700; color: var(--primary); background: var(--primary-light); padding: 2px 6px; border-radius: 4px; margin-left: 4px;">ID #{{ booking.linked_booking.id }}</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">PASSENGER</div>
                                        <div style="font-weight: 500; color: var(--dark);">{{ booking.linked_booking.passenger_name }}</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">{{ booking.linked_booking.phone_number|default:booking.linked_booking.passenger_email }}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">PICKUP</div>
                                        <div style="font-size: 14px; color: var(--dark);">{{ booking.linked_booking.pick_up_address }}</div>
                                        {% if booking.linked_booking.drop_off_address %}
                                        <div style="font-size: 13px; color: var(--text-secondary);">→ {{ booking.linked_booking.drop_off_address }}</div>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">DATE & TIME</div>
                                        <div style="font-weight: 500;">{{ booking.linked_booking.pick_up_date }}</div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">{{ booking.linked_booking.pick_up_time }}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">STATUS</div>
                                        <span class="badge badge-{{ booking.linked_booking.status|lower }}">{{ booking.linked_booking.get_status_display }}</span>
                                    </div>
                                    {% if is_admin %}
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">DRIVER</div>
                                        {% if booking.linked_booking.assigned_driver %}
                                            <div style="font-weight: 500; color: var(--dark);">{{ booking.linked_booking.assigned_driver.full_name }}</div>
                                            <div style="font-size: 13px; color: var(--text-secondary);">{{ booking.linked_booking.assigned_driver.car_type }}</div>
                                        {% else %}
                                            <span style="color: var(--text-muted); font-size: 13px;">Not assigned</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">ACTIONS</div>
                                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                            <a href="{% url 'booking_detail' booking.linked_booking.id %}" class="action-link">View</a>
                                            {% if is_admin %}
                                                <a href="{% url 'assign_driver' booking.linked_booking.id %}" class="action-link">Assign Driver</a>
                                            {% else %}
                                                {% if booking.linked_booking.status in 'Pending,Confirmed' and booking.linked_booking.hours_until_pickup > 2 %}
                                                    <a href="{% url 'update_booking' booking.linked_booking.id %}" class="action-link">Edit Return</a>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if page_obj.has_other_pages %}
        <div style="margin-top: 24px; display: flex; justify-content: center; align-items: center; gap: 16px; flex-wrap: wrap;">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-secondary">← Previous</a>
            {% endif %}

            <span style="color: var(--text-secondary);">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="btn btn-secondary">Next →</a>
            {% endif %}
        </div>
        {% endif %}
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <svg style="width: 40px; height: 40px; color: var(--border-dark);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
            </div>
            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--dark);">No bookings yet</h3>
        </div>
    {% endif %}

    {% if is_admin and booking_history %}
    <div id="activity" style="margin-top: 40px; background: white; border-radius: var(--radius-xl); box-shadow: var(--shadow-sm); border: 1px solid var(--border-light); overflow: hidden; scroll-margin-top: 80px;">
        <div style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); padding: 24px; border-bottom: 1px solid var(--border-light);">
            <div style="display: flex; align-items: center; gap: 14px;">
                <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: var(--radius-lg);">
                    <svg style="width: 24px; height: 24px; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div>
                    <h2 style="font-size: 18px; font-weight: 700; margin: 0; color: white;">Recent Booking Activity</h2>
                    <p style="font-size: 13px; color: rgba(255,255,255,0.8); margin: 4px 0 0 0;">Complete audit trail of all booking changes</p>
                </div>
            </div>
        </div>

        <div style="max-height: 600px; overflow-y: auto;">
            <table class="booking-table" style="margin: 0;">
                <thead style="position: sticky; top: 0; background: #f8fafc; z-index: 10;">
                    <tr>
                        <th style="padding: 16px;">Timestamp</th>
                        <th style="padding: 16px;">Booking</th>
                        <th style="padding: 16px;">Action</th>
                        <th style="padding: 16px;">Changed By</th>
                        <th style="padding: 16px;">Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for history in booking_history %}
                    <tr style="border-bottom: 1px solid var(--border-light);">
                        <td style="padding: 16px;">
                            <div style="display: flex; flex-direction: column; gap: 2px;">
                                <span style="font-weight: 600; color: var(--dark); font-size: 13px;">
                                    {{ history.changed_at|date:"M d, Y" }}
                                </span>
                                <span style="color: var(--text-secondary); font-size: 12px;">
                                    {{ history.changed_at|time:"g:i A" }}
                                </span>
                            </div>
                        </td>
                        <td style="padding: 16px;">
                            <div style="display: flex; flex-direction: column; gap: 2px;">
                                <a href="{% url 'booking_detail' history.booking.id %}" style="color: var(--primary); font-weight: 600; text-decoration: none; font-size: 13px;">
                                    #{{ history.booking.id }}
                                </a>
                                <span style="color: var(--text-secondary); font-size: 12px;">
                                    {{ history.booking.passenger_name }}
                                </span>
                                {% if history.booking.user %}
                                <span style="color: var(--text-secondary); font-size: 11px;">
                                    User: {{ history.booking.user.username }}
                                </span>
                                {% endif %}
                            </div>
                        </td>
                        <td style="padding: 16px;">
                            {% if history.action == 'created' %}
                                <span class="status-badge" style="background: rgba(16, 185, 129, 0.1); color: #059669; border-color: rgba(16, 185, 129, 0.2);">
                                    Created
                                </span>
                            {% elif history.action == 'status_changed' %}
                                <span class="status-badge" style="background: rgba(59, 130, 246, 0.1); color: #2563eb; border-color: rgba(59, 130, 246, 0.2);">
                                    Status Changed
                                </span>
                            {% elif history.action == 'updated' %}
                                <span class="status-badge" style="background: rgba(245, 158, 11, 0.1); color: #d97706; border-color: rgba(245, 158, 11, 0.2);">
                                    Updated
                                </span>
                            {% elif history.action == 'cancelled' %}
                                <span class="status-badge" style="background: rgba(239, 68, 68, 0.1); color: #dc2626; border-color: rgba(239, 68, 68, 0.2);">
                                    Cancelled
                                </span>
                            {% elif history.action == 'driver_assigned' %}
                                <span class="status-badge" style="background: rgba(99, 102, 241, 0.1); color: #4f46e5; border-color: rgba(99, 102, 241, 0.2);">
                                    Driver Assigned
                                </span>
                            {% elif history.action == 'driver_rejected' %}
                                <span class="status-badge" style="background: rgba(239, 68, 68, 0.1); color: #dc2626; border-color: rgba(239, 68, 68, 0.2);">
                                    Driver Rejected
                                </span>
                            {% elif history.action == 'driver_completed' %}
                                <span class="status-badge" style="background: rgba(16, 185, 129, 0.1); color: #059669; border-color: rgba(16, 185, 129, 0.2);">
                                    Trip Completed
                                </span>
                            {% endif %}
                        </td>
                        <td style="padding: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                {% if history.action == 'driver_assigned' or history.action == 'driver_rejected' or history.action == 'driver_completed' %}
                                    {% if history.changed_by %}
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #6d6d6d 0%, #949394 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">
                                            {{ history.changed_by.username.0|upper }}
                                        </div>
                                        <span style="font-weight: 500; color: var(--dark); font-size: 13px;">
                                            {{ history.changed_by.username }}
                                        </span>
                                    {% else %}
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">
                                            
                                        </div>
                                        <span style="font-weight: 500; color: var(--dark); font-size: 13px;">
                                            Driver
                                        </span>
                                    {% endif %}
                                {% else %}
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #6d6d6d 0%, #949394 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">
                                        {{ history.changed_by.username.0|upper }}
                                    </div>
                                    <span style="font-weight: 500; color: var(--dark); font-size: 13px;">
                                        {{ history.changed_by.username|default:"System" }}
                                    </span>
                                {% endif %}
                            </div>
                        </td>
                        <td style="padding: 16px;">
                            {% if history.changes %}
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                {% for field in history.get_changed_fields %}
                                {% with change_data=history|get_field_change:field %}
                                <div style="background: rgba(248, 250, 252, 1); padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(226, 232, 240, 1);">
                                    <div style="font-weight: 600; color: #2563eb; font-size: 11px; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
                                        {{ field|format_field_name }}
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px; font-size: 12px;">
                                        <span style="color: #dc2626; background: rgba(220, 38, 38, 0.1); padding: 2px 8px; border-radius: 4px; font-family: monospace;">
                                            {{ change_data.old|default:"(empty)" }}
                                        </span>
                                        <svg style="width: 12px; height: 12px; color: var(--text-secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                                        </svg>
                                        <span style="color: #059669; background: rgba(5, 150, 105, 0.1); padding: 2px 8px; border-radius: 4px; font-family: monospace;">
                                            {{ change_data.new|default:"(empty)" }}
                                        </span>
                                    </div>
                                </div>
                                {% endwith %}
                                {% endfor %}
                            </div>
                            {% else %}
                            <span style="color: var(--text-secondary); font-size: 12px;">Initial creation</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div style="padding: 16px; background: #f8fafc; border-top: 1px solid var(--border-light); text-align: center;">
            <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">
                Showing last 50 booking changes. View individual bookings for complete history.
            </p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleReturn(bookingId) {
    const returnRow = document.querySelector('.return-row-' + bookingId);
    const expandIcon = document.querySelector('.expand-icon-' + bookingId);
    const expandBtn = document.querySelector('.expand-btn-' + bookingId);

    // Toggle between shown and hidden states
    if (returnRow.style.display === 'table-row') {
        returnRow.style.display = 'none';
        expandIcon.style.transform = 'rotate(0deg)';
        expandBtn.innerHTML = expandBtn.innerHTML.replace('Hide Return', 'Show Return');
    } else {
        returnRow.style.display = 'table-row';
        expandIcon.style.transform = 'rotate(180deg)';
        expandBtn.innerHTML = expandBtn.innerHTML.replace('Show Return', 'Hide Return');
    }
}
</script>
{% endblock %}