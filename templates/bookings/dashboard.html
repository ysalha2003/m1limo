{% extends "base.html" %}
{% load booking_filters %}

{% block title %}Dashboard - M1 Limousine Service{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 16px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        border: 2px solid #e2e8f0;
        transition: all 200ms ease;
        position: relative;
        overflow: hidden;
        text-decoration: none;
        color: inherit;
        display: flex;
        flex-direction: column;
        cursor: pointer;
        height: 100px;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, transparent 100%);
        opacity: 0;
        transition: opacity 200ms ease;
        pointer-events: none;
    }

    .stat-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: scale(1.015);
    }

    .stat-card:hover::before {
        opacity: 1;
    }

    .stat-card:active {
        transform: scale(0.995);
    }

    .stat-card.active {
        border-width: 3px;
        box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.08), 0 4px 12px rgba(15, 23, 42, 0.12);
        transform: scale(1.005);
        padding: 15px; /* Compensate for thicker border */
    }

    /* Pending Card - Softer Amber Theme */
    .stat-card.pending-card {
        background: linear-gradient(135deg, #fffcf5 0%, #fef9eb 100%);
        border-color: rgba(232, 180, 79, 0.25);
    }

    .stat-card.pending-card:hover {
        background: linear-gradient(135deg, #fef9eb 0%, #fef5dc 100%);
        border-color: rgba(232, 180, 79, 0.4);
        box-shadow: 0 4px 12px rgba(232, 180, 79, 0.1);
    }

    .stat-card.pending-card.active {
        background: linear-gradient(135deg, #fef9eb 0%, #fef5dc 100%);
        border-color: rgba(232, 180, 79, 0.6);
        box-shadow: 0 0 0 3px rgba(232, 180, 79, 0.08), 0 4px 12px rgba(232, 180, 79, 0.15);
        padding: 15px;
    }

    .stat-card.pending-card.inactive {
        opacity: 0.65;
        filter: saturate(0.7);
    }

    /* Confirmed Card - Softer Sage/Mint Theme */
    .stat-card.confirmed-card {
        background: linear-gradient(135deg, #f9fdfb 0%, #f3faf5 100%);
        border-color: rgba(46, 125, 50, 0.2);
    }

    .stat-card.confirmed-card:hover {
        background: linear-gradient(135deg, #f3faf5 0%, #e8f5e9 100%);
        border-color: rgba(46, 125, 50, 0.35);
        box-shadow: 0 4px 12px rgba(46, 125, 50, 0.1);
    }

    .stat-card.confirmed-card.active {
        background: linear-gradient(135deg, #f3faf5 0%, #e8f5e9 100%);
        border-color: rgba(46, 125, 50, 0.5);
        box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.08), 0 4px 12px rgba(46, 125, 50, 0.15);
        padding: 15px;
    }

    .stat-card.confirmed-card.inactive {
        opacity: 0.65;
        filter: saturate(0.7);
    }

    /* Next Reservation Card - Softer Sky Blue Theme */
    .stat-card.next-reservation-card {
        background: linear-gradient(135deg, #f7fbfe 0%, #f0f9ff 100%);
        border-color: rgba(125, 211, 252, 0.3);
    }

    .stat-card.next-reservation-card:hover {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border-color: rgba(125, 211, 252, 0.5);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.12);
    }

    .stat-card.next-reservation-card:active {
        transform: scale(0.995);
    }

    /* Pulsing animation for urgent reservations */
    @keyframes pulse-glow {
        0%, 100% {
            border-color: #ef4444;
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4), 0 4px 12px rgba(239, 68, 68, 0.2);
        }
        50% {
            border-color: #dc2626;
            box-shadow: 0 0 0 6px rgba(239, 68, 68, 0), 0 4px 16px rgba(239, 68, 68, 0.3);
        }
    }

    .stat-card.urgent {
        animation: pulse-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    }

    .stat-card.active::before {
        opacity: 1;
        background: linear-gradient(90deg, transparent 0%, var(--primary) 50%, transparent 100%);
    }

    /* Sortable columns */
    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 24px !important;
        transition: background-color 0.2s;
    }

    .sortable:hover {
        background-color: rgba(15, 23, 42, 0.05);
    }

    .sort-icon {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 11px;
        color: var(--text-secondary);
        opacity: 0.5;
    }

    .sortable.sort-asc .sort-icon::after {
        content: ' ▲';
        color: var(--primary);
        opacity: 1;
    }

    .sortable.sort-desc .sort-icon::after {
        content: ' ▼';
        color: var(--primary);
        opacity: 1;
    }

    .stat-icon {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
        position: relative;
        flex-shrink: 0;
    }

    .stat-icon::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: linear-gradient(135deg, rgba(255,255,255,0.6) 0%, transparent 100%);
        pointer-events: none;
    }

    .stat-icon svg {
        transition: transform 200ms ease;
    }

    .stat-card:hover .stat-icon svg {
        transform: scale(1.1);
    }

    .stat-value {
        font-size: 34px;
        font-weight: 700;
        color: var(--dark);
        line-height: 1;
        letter-spacing: -0.03em;
        margin: auto 0;
    }

    .stat-label {
        color: #64748b;
        font-size: 14px;
        margin: 0;
        font-weight: 600;
        letter-spacing: -0.01em;
    }

    .filter-hint {
        color: #94a3b8;
        font-size: 11px;
        margin: 0;
        font-weight: 500;
        opacity: 0;
        transition: opacity 200ms ease;
        position: absolute;
        bottom: 12px;
        left: 16px;
    }

    .stat-card:hover .filter-hint {
        opacity: 0.7;
    }

    .active-indicator {
        display: none;
        align-items: center;
        gap: 4px;
        color: var(--primary);
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        position: absolute;
        bottom: 12px;
        left: 16px;
    }

    .stat-card.active .active-indicator {
        display: flex;
    }

    .stat-card.active .filter-hint {
        display: none;
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }

    .today-pickups-card {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.03) 0%, rgba(51, 65, 85, 0.03) 100%);
        border: 1px solid rgba(30, 41, 59, 0.12);
        border-radius: 12px;
        padding: 14px 16px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        position: relative;
        overflow: hidden;
    }

    .today-pickups-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(to bottom, var(--pending) 0%, var(--accent) 100%);
    }

    .pickup-item {
        background: white;
        border-radius: 10px;
        padding: 12px 14px;
        border: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .pickup-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        border-color: #cbd5e1;
        transform: translateY(-2px);
    }

    /* Time badge with color coding */
    .time-badge {
        font-weight: 600;
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        letter-spacing: -0.01em;
    }

    .time-badge.time-safe {
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        color: #2e7d32;
        border: 1px solid #81c784;
    }

    .time-badge.time-warning {
        background: linear-gradient(135deg, #fef9e7 0%, #fdedb4 100%);
        color: #8b6914;
        border: 1px solid #e8b44f;
    }

    .time-badge.time-urgent {
        background: linear-gradient(135deg, #fef0ef 0%, #fddbd9 100%);
        color: #8b302b;
        border: 1px solid #e87f77;
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    .search-form {
        background: linear-gradient(to bottom, white 0%, var(--light) 100%);
        padding: 24px;
        border-radius: var(--radius-lg);
        margin-bottom: 28px;
        border: 1px solid var(--border-light);
        box-shadow: var(--shadow-xs);
    }

    .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }

    th {
        padding: 10px 8px;
        color: var(--text-secondary);
        font-weight: 600;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        border-bottom: 1.5px solid var(--border);
        text-align: left;
        white-space: nowrap;
    }

    td {
        padding: 12px 8px;
        border-bottom: 1px solid var(--border);
    }

    tr:hover {
        background: linear-gradient(to right, #f8fafc 0%, #f1f5f9 100%);
        transition: all 0.2s ease;
    }

    /* Enhanced action buttons */
    .action-link {
        color: var(--primary);
        text-decoration: none;
        font-weight: 600;
        font-size: 12px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        white-space: nowrap;
        padding: 5px 10px;
        border-radius: 6px;
        background: var(--primary-light);
        border: 1px solid transparent;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .action-link:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(15, 23, 42, 0.12);
    }

    .action-link.action-approve {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .action-link.action-approve:hover {
        background: #8fbc8f;
        color: white;
    }

    .action-link.action-complete {
        background: #f0f9ff;
        color: #0c4a6e;
    }

    .action-link.action-complete:hover {
        background: #7dd3fc;
        color: white;
    }

    /* Enhanced status badges in table */
    .badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        border: 1px solid;
        letter-spacing: 0.01em;
        transition: all 0.2s ease;
    }

    .badge svg {
        width: 12px;
        height: 12px;
    }

    /* Hover preview for table rows */
    tbody tr {
        position: relative;
        transition: all 0.3s ease;
    }

    tbody tr:hover {
        z-index: 10;
    }

    tbody tr:hover::after {
        content: '';
        position: absolute;
        left: -2px;
        top: -1px;
        bottom: -1px;
        width: 3px;
        background: var(--primary);
        border-radius: 2px;
    }

    .round-trip-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 8px;
        background: var(--info-light);
        color: #1e40af;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 700;
        white-space: nowrap;
    }

    .expand-btn {
        color: var(--primary);
        background: none;
        border: none;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        padding: 0;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: var(--transition);
    }

    .expand-btn:hover {
        color: var(--primary-hover);
    }

    .expand-icon {
        width: 14px;
        height: 14px;
        transition: transform 0.2s;
    }

    .return-row {
        background: #f8fafc;
    }

    .return-trip-content {
        border-left: 3px solid var(--primary);
        padding-left: 16px;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }

    .empty-icon {
        width: 80px;
        height: 80px;
        background: var(--light-gray);
        border-radius: 50%;
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    @media (max-width: 1024px) {
        .stat-card {
            padding: 14px;
            height: 90px;
        }

        .stat-value {
            font-size: 30px;
        }

        .stat-label {
            font-size: 13px;
        }

        .stat-icon {
            width: 22px;
            height: 22px;
        }

        .stat-icon svg {
            width: 13px;
            height: 13px;
        }

        table {
            font-size: 13px;
        }

        th, td {
            padding: 10px 6px;
        }
    }

    @media (max-width: 768px) {
        .stat-card {
            padding: 14px;
            height: 90px !important;
            flex: 1 1 100% !important;
            min-width: 100% !important;
        }

        .stat-card.pending-card,
        .stat-card.confirmed-card {
            flex: 1 1 calc(50% - 9px) !important;
            min-width: calc(50% - 9px) !important;
        }

        .stat-icon {
            width: 22px;
            height: 22px;
        }

        .stat-icon svg {
            width: 13px;
            height: 13px;
        }

        .stat-value {
            font-size: 28px;
        }

        .stat-label {
            font-size: 13px;
        }

        .welcome-banner {
            padding: 10px 14px !important;
            margin-bottom: 16px !important;
        }

        .welcome-banner h1 {
            font-size: 14px !important;
        }

        .welcome-banner p {
            font-size: 11px !important;
        }

        /* Alert banners responsive */
        div[style*="border-radius: 12px"][style*="padding: 14px 16px"] {
            padding: 12px 14px !important;
            border-radius: 10px !important;
        }

        div[style*="border-radius: 12px"] h3 {
            font-size: 14px !important;
        }

        div[style*="border-radius: 12px"] p {
            font-size: 12px !important;
        }

        /* Icon containers in alerts */
        div[style*="width: 40px; height: 40px"] {
            width: 36px !important;
            height: 36px !important;
        }

        div[style*="width: 40px; height: 40px"] svg {
            width: 20px !important;
            height: 20px !important;
        }

        .today-pickups-card {
            padding: 12px 14px;
        }

        .pickup-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
        }

        .pickup-actions {
            display: flex;
            gap: 8px;
            width: 100%;
            flex-wrap: wrap;
        }

        .search-form {
            padding: 14px;
        }

        table {
            font-size: 12px;
        }

        th {
            padding: 10px 6px;
            font-size: 11px;
        }

        td {
            padding: 12px 6px;
        }

        .action-link {
            font-size: 12px;
        }

        /* Hide less important columns on mobile */
        .hide-mobile {
            display: none;
        }
    }

    @media (max-width: 480px) {
        .stat-card {
            padding: 14px;
            height: auto !important;
            min-height: 85px;
            flex: 1 1 100% !important;
            min-width: 100% !important;
        }

        .stat-card.pending-card,
        .stat-card.confirmed-card {
            flex: 1 1 100% !important;
            min-width: 100% !important;
        }
        
        .stat-icon {
            width: 20px;
            height: 20px;
        }

        .stat-icon svg {
            width: 12px;
            height: 12px;
        }
        
        .stat-value {
            font-size: 26px;
        }
        
        .stat-label {
            font-size: 12px;
        }

        .welcome-banner {
            padding: 10px 12px !important;
            margin-bottom: 14px !important;
            border-left-width: 2px !important;
        }

        .welcome-banner h1 {
            font-size: 14px !important;
            margin-bottom: 2px !important;
        }
        
        .welcome-banner p {
            font-size: 11px !important;
        }

        /* Alert banners on small screens */
        div[style*="border-radius: 12px"][style*="padding"] {
            padding: 10px 12px !important;
            border-radius: 8px !important;
            margin-bottom: 14px !important;
            gap: 10px !important;
        }

        div[style*="border-radius: 12px"] h3 {
            font-size: 13px !important;
            margin-bottom: 4px !important;
        }

        div[style*="border-radius: 12px"] p {
            font-size: 11px !important;
            margin-bottom: 10px !important;
        }

        /* Alert icon containers */
        div[style*="width: 40px"],
        div[style*="width: 36px"] {
            width: 32px !important;
            height: 32px !important;
            min-width: 32px !important;
        }

        div[style*="width: 40px"] svg,
        div[style*="width: 36px"] svg {
            width: 18px !important;
            height: 18px !important;
        }

        .pickup-item {
            padding: 10px;
            gap: 10px;
        }
        
        .card {
            padding: 12px !important;
            border-radius: 8px !important;
        }
        
        .btn {
            padding: 7px 12px !important;
            font-size: 12px !important;
        }

        /* Stats grid gap */
        div[style*="display: flex; gap: 18px"] {
            gap: 12px !important;
        }
    }

    /* Pulse animation for notification badges */
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.7;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="welcome-banner" style="padding: 12px 16px; border-left-width: 2px; margin-bottom: 24px;">
    <h1 style="font-size: 16px; font-weight: 600; margin-bottom: 2px;">{% if is_admin %}Admin Dashboard{% else %}My Dashboard{% endif %}</h1>
    <p style="font-size: 12px; opacity: 0.65; margin: 0;">{% if is_admin %}Manage all reservations and operations{% else %}View and manage your reservations{% endif %}</p>
</div>

{% if is_admin and past_confirmed_count > 0 %}
<!-- Past Confirmed Reservations Alert Banner -->
<div style="background: linear-gradient(135deg, #f0f9ff 0%, #bae6fd 100%); border: 2px solid #7dd3fc; border-radius: 12px; padding: 14px 16px; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(125, 211, 252, 0.08);">
    <div style="display: flex; align-items: start; gap: 12px;">
        <div style="flex-shrink: 0; width: 40px; height: 40px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
            <svg style="width: 22px; height: 22px; color: #7dd3fc;" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
        </div>
        <div style="flex: 1;">
            <h3 style="color: #0c4a6e; font-size: 15px; font-weight: 700; margin: 0 0 6px 0;">
                {{ past_confirmed_count }} Confirmed Reservation{{ past_confirmed_count|pluralize }} Require{{ past_confirmed_count|pluralize:"s," }} Action
            </h3>
            <p style="color: #0c4a6e; font-size: 13px; margin: 0 0 12px 0; line-height: 1.5;">
                These reservations have passed their pickup time and are still marked as "Confirmed". 
                Please review and update their status to Trip Completed, Customer No-Show, or Cancelled.
            </p>
            <a href="{% url 'past_confirmed_reservations' %}" class="btn" style="background: #7dd3fc; color: #0c4a6e; font-weight: 600; padding: 7px 14px; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(125, 211, 252, 0.2); font-size: 13px;">
                <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                Review {{ past_confirmed_count }} Reservation{{ past_confirmed_count|pluralize }}
            </a>
        </div>
    </div>
</div>
{% endif %}

{% if is_admin and past_pending_count > 0 %}
<!-- Past Pending Reservations Alert Banner -->
<div style="background: linear-gradient(135deg, #fef9e7 0%, #fdedb4 100%); border: 2px solid #e8b44f; border-radius: 12px; padding: 14px 16px; margin-bottom: 20px; box-shadow: 0 2px 6px rgba(232, 180, 79, 0.08);">
    <div style="display: flex; align-items: start; gap: 12px;">
        <div style="flex-shrink: 0; width: 40px; height: 40px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
            <svg style="width: 22px; height: 22px; color: #e8b44f;" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
        </div>
        <div style="flex: 1;">
            <h3 style="color: #8b6914; font-size: 15px; font-weight: 700; margin: 0 0 6px 0;">
                {{ past_pending_count }} Pending Request{{ past_pending_count|pluralize }} Need Review
            </h3>
            <p style="color: #8b6914; font-size: 13px; margin: 0 0 12px 0; line-height: 1.5;">
                These requests were never confirmed and have passed their pickup time. 
                Please review and decide next action.
            </p>
            <a href="{% url 'past_pending_reservations' %}" class="btn" style="background: #e8b44f; color: #8b6914; font-weight: 600; padding: 7px 14px; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(232, 180, 79, 0.2); font-size: 13px;">
                <svg style="width: 16px; height: 16px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                Review {{ past_pending_count }} Request{{ past_pending_count|pluralize }}
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Stats Grid -->
<div style="display: flex; gap: 18px; margin-bottom: 36px; flex-wrap: wrap;">
    <!-- Pending Filter Card -->
    <a href="?status=Pending" 
       class="stat-card pending-card {% if request.GET.status == 'Pending' %}active{% elif request.GET.status == 'Confirmed' %}inactive{% endif %}" 
       style="flex: 0 0 190px;"
       aria-label="Filter by pending reservations"
       role="button">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
            <p class="stat-label">Pending</p>
            <div class="stat-icon" style="background: linear-gradient(135deg, #fef5dc 0%, #fdedb4 100%);">
                <svg style="width: 14px; height: 14px; color: #a0790b; position: relative; z-index: 1;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
        </div>
        <p class="stat-value" style="color: #a0790b;">{{ stats.pending_count|default:0 }}</p>
        <p class="filter-hint">Click to filter</p>
        <div class="active-indicator">
            <span style="width: 6px; height: 6px; background: var(--primary); border-radius: 50%; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;"></span>
            Filtering
        </div>
    </a>

    <!-- Confirmed Filter Card -->
    <a href="?status=Confirmed" 
       class="stat-card confirmed-card {% if request.GET.status == 'Confirmed' %}active{% elif request.GET.status == 'Pending' %}inactive{% endif %}" 
       style="flex: 0 0 190px;"
       aria-label="Filter by confirmed reservations"
       role="button">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
            <p class="stat-label">Confirmed</p>
            <div class="stat-icon" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                <svg style="width: 14px; height: 14px; color: #2d6a3c; position: relative; z-index: 1;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                </svg>
            </div>
        </div>
        <p class="stat-value" style="color: #2d6a3c;">{{ stats.confirmed_count|default:0 }}</p>
        <p class="filter-hint">Click to filter</p>
        <div class="active-indicator">
            <span style="width: 6px; height: 6px; background: var(--primary); border-radius: 50%; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;"></span>
            Filtering
        </div>
    </a>

    <!-- Next Reservation Card -->
    <div class="stat-card next-reservation-card {% if next_upcoming_trip.hours_until_pickup <= 2 %}urgent{% endif %}" 
         style="flex: 1; min-width: 400px; height: 100px; position: relative; {% if not next_upcoming_trip %}cursor: default; pointer-events: none; opacity: 0.6;{% else %}cursor: pointer;{% endif %}"
         {% if next_upcoming_trip %}onclick="window.location.href='{% url 'reservation_detail' next_upcoming_trip.id %}'"{% endif %}
         aria-label="{% if next_upcoming_trip %}View next reservation details{% else %}No upcoming reservations{% endif %}"
         role="{% if next_upcoming_trip %}button{% else %}presentation{% endif %}">
        
        <div style="display: flex; flex-direction: column; height: 100%; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <p class="stat-label" style="font-size: 13px; font-weight: 600; color: #0c4a6e; margin: 0;">Next Reservation</p>
                    {% if next_upcoming_trips and next_upcoming_trips|length > 1 %}
                        <span id="trip-counter" style="font-size: 10px; font-weight: 600; color: #0369a1; background: #e0f2fe; padding: 2px 6px; border-radius: 4px;">
                            1/{{ next_upcoming_trips|length }}
                        </span>
                    {% endif %}
                </div>
                <div class="stat-icon" style="background: linear-gradient(135deg, #bae6fd 0%, #7dd3fc 100%); width: 20px; height: 20px;">
                    <svg style="width: 12px; height: 12px; color: white; position: relative; z-index: 1;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                </div>
            </div>
            
            {% if next_upcoming_trip %}
                <!-- Container for all trips (will rotate if multiple) -->
                <div id="next-reservation-container" style="position: relative; flex: 1;">
                    {% for trip in next_upcoming_trips %}
                    <div class="trip-rotation-item" 
                         data-trip-index="{{ forloop.counter0 }}"
                         data-trip-id="{{ trip.id }}"
                         style="display: {% if forloop.first %}flex{% else %}none{% endif %}; align-items: center; gap: 8px; flex-wrap: wrap; position: absolute; top: 0; left: 0; right: 0; opacity: {% if forloop.first %}1{% else %}0{% endif %}; transition: opacity 0.5s ease-in-out;">
                        <!-- Date & Time -->
                        <div style="display: flex; align-items: baseline; gap: 6px;">
                            <span style="color: #0c4a6e; font-size: 14px; font-weight: 700; white-space: nowrap;">
                                {{ trip.pick_up_date|date:"M d, Y" }}
                            </span>
                            <span style="color: #0369a1; font-size: 13px; font-weight: 600; white-space: nowrap;">
                                {{ trip.pick_up_time|time:"g:i A" }}
                            </span>
                        </div>
                        
                        <!-- Countdown Badge -->
                        {% load booking_filters %}
                        {% with time_remaining=trip|format_time_until_pickup %}
                            {% if time_remaining %}
                                {% if time_remaining.total_hours < 24 %}
                                    <div style="display: inline-flex; align-items: center; background: #fee2e2; color: #991b1b; padding: 3px 7px; border-radius: 4px; font-size: 10px; font-weight: 700; white-space: nowrap;">
                                        <span class="live-countdown" 
                                              data-pickup-date="{{ trip.pick_up_date|date:'Y-m-d' }}" 
                                              data-pickup-time="{{ trip.pick_up_time|time:'H:i:s' }}">
                                            Calculating...
                                        </span>
                                    </div>
                                {% elif time_remaining.days > 0 %}
                                    <div style="display: inline-flex; align-items: center; background: #fef9e7; color: #8b6914; padding: 3px 7px; border-radius: 4px; font-size: 10px; font-weight: 700; white-space: nowrap;">
                                        {{ time_remaining.days }}d {{ time_remaining.hours }}h
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endwith %}
                        
                        <span style="color: #cbd5e1; font-weight: 300; font-size: 14px;">│</span>
                        
                        <!-- Location -->
                        <div style="display: flex; align-items: center; gap: 4px; min-width: 0;">
                            <svg style="width: 12px; height: 12px; color: #7dd3fc; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            </svg>
                            <span style="color: #334155; font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ trip.pick_up_address|truncatewords:3 }}</span>
                        </div>
                        
                        <span style="color: #e2e8f0; font-size: 12px;">•</span>
                        
                        <!-- Passenger -->
                        <div style="display: flex; align-items: center; gap: 4px; min-width: 0;">
                            <svg style="width: 12px; height: 12px; color: #a78bfa; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            <span style="color: #334155; font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ trip.passenger_name|truncatewords:2 }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="display: flex; align-items: center; justify-content: center; flex: 1; color: #94a3b8; font-size: 13px;">
                    No upcoming reservations
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Today's Pickups -->
{% if today_pickups %}
<div class="today-pickups-card">
    <div style="display: flex; align-items: center; gap: 14px; margin-bottom: 24px;">
        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--pending) 0%, var(--accent) 100%); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); position: relative;">
            <div style="position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 100%); border-radius: inherit;"></div>
            <svg style="width: 26px; height: 26px; color: white; position: relative; z-index: 1;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
        </div>
        <h2 style="font-size: 19px; font-weight: 700; margin: 0; color: var(--dark); letter-spacing: -0.02em;">Today's Pickups <span style="color: var(--text-secondary); font-weight: 600;">({{ today_pickups|length }})</span></h2>
    </div>

    <div style="display: grid; gap: 12px;">
        {% for booking in today_pickups %}
        <div class="pickup-item">
            <div style="flex: 1; min-width: 0;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px; flex-wrap: wrap;">
                    <!-- Enhanced time display with color coding -->
                    {% if booking.hours_until_pickup > 2 %}
                        <span class="time-badge time-safe">
                            <svg style="width: 12px; height: 12px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            {{ booking.pick_up_time }}
                        </span>
                        <span style="font-size: 11px; color: #2e7d32; font-weight: 600;">{{ booking.time_until_pickup_formatted }} away</span>
                    {% elif booking.hours_until_pickup > 1 %}
                        <span class="time-badge time-warning">
                            <svg style="width: 12px; height: 12px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            {{ booking.pick_up_time }}
                        </span>
                        <span style="font-size: 11px; color: #8b6914; font-weight: 700;">{{ booking.time_until_pickup_formatted }} away</span>
                    {% else %}
                        <span class="time-badge time-urgent">
                            <svg style="width: 12px; height: 12px; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            {{ booking.pick_up_time }}
                        </span>
                        <span style="font-size: 11px; color: #8b302b; font-weight: 700; text-transform: uppercase;">{{ booking.time_until_pickup_formatted }} away</span>
                    {% endif %}
                    <span class="badge badge-{{ booking.status|lower }}">{{ booking.get_status_display }}</span>
                    {% if booking.trip_type == 'Round' and booking.linked_booking %}
                        <span class="round-trip-badge">
                            <svg style="width: 10px; height: 10px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                            </svg>
                            ROUND
                        </span>
                    {% endif %}
                </div>
                <div style="font-weight: 600; color: var(--dark); margin-bottom: 4px; font-size: 13px;">
                    {{ booking.passenger_name }}
                    {% if booking.trip_label %}
                        <span style="font-size: 11px; color: var(--text-secondary); font-weight: 500; margin-left: 6px;">({{ booking.trip_label }})</span>
                    {% endif %}
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);"> {{ booking.pick_up_address }}</div>
                {% if booking.drop_off_address %}
                <div style="font-size: 12px; color: var(--text-secondary);">→ {{ booking.drop_off_address }}</div>
                {% endif %}
                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">{{ booking.vehicle_type }} • {{ booking.phone_number|default:booking.passenger_email }}</div>
            </div>
            <div class="pickup-actions">
                {% if is_admin and booking.status == 'Confirmed' %}
                    {% if booking.hours_until_pickup <= 0 %}
                        <a href="{% url 'reservation_actions' booking.id 'complete' %}" class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;">✓ Complete</a>
                    {% else %}
                        <span class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px; opacity: 0.5; cursor: not-allowed; pointer-events: none;" title="Cannot complete until after pickup time ({{ booking.time_until_pickup_formatted }} remaining)">✓ Complete</span>
                    {% endif %}
                {% endif %}
                <a href="{% url 'reservation_detail' booking.id %}" class="btn btn-secondary" style="font-size: 12px; padding: 6px 12px;">View</a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Bookings List -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
        <h2 style="font-size: 15px; font-weight: 700; margin: 0; color: var(--dark);">
            {% if is_admin %}All Reservations{% else %}Your Reservations{% endif %}
        </h2>
        <a href="{% url 'new_reservation' %}" class="btn" style="background: #1e293b; color: white; font-weight: 600; padding: 7px 14px; font-size: 13px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);">+ New Reservation</a>
    </div>

    <!-- Search & Filter -->
    <form method="get" class="search-form">
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 12px; align-items: end;">
            <div class="form-group" style="margin: 0;">
                <label class="form-label" style="font-size: 11px; margin-bottom: 4px;">Search</label>
                <input type="text" name="search" class="form-input" placeholder="Trip #ID, Name, Phone, or Reference Number" value="{{ request.GET.search }}" style="margin: 0; height: 36px; font-size: 13px; border-color: #cbd5e1; padding: 8px 12px;">
            </div>

            <div class="form-group" style="margin: 0;">
                <label class="form-label" style="font-size: 11px; margin-bottom: 4px;">Date From</label>
                <input type="date" name="date_from" class="form-input" value="{{ request.GET.date_from }}" style="margin: 0; height: 36px; font-size: 13px; border-color: #cbd5e1; padding: 8px 12px;">
            </div>

            <div class="form-group" style="margin: 0;">
                <label class="form-label" style="font-size: 11px; margin-bottom: 4px;">Date To</label>
                <input type="date" name="date_to" class="form-input" value="{{ request.GET.date_to }}" style="margin: 0; height: 36px; font-size: 13px; border-color: #cbd5e1; padding: 8px 12px;">
            </div>

            <div class="form-group" style="margin: 0;">
                <label class="form-label" style="font-size: 11px; margin-bottom: 4px;">Status</label>
                <select name="status" id="statusFilter" class="form-select" style="margin: 0; height: 36px; font-size: 13px; border-color: #cbd5e1; padding: 8px 12px;" onchange="this.form.submit()">
                    <option value="">All States</option>
                    <option value="Pending" {% if request.GET.status == 'Pending' %}selected{% endif %}>Pending</option>
                    <option value="Confirmed" {% if request.GET.status == 'Confirmed' %}selected{% endif %}>Confirmed</option>
                    <option value="Trip_Completed" {% if request.GET.status == 'Trip_Completed' %}selected{% endif %}>Completed</option>
                    <option value="Cancelled" {% if request.GET.status == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                    <option value="Cancelled_Full_Charge" {% if request.GET.status == 'Cancelled_Full_Charge' %}selected{% endif %}>Cancelled (Full Charge)</option>
                </select>
            </div>

            <div style="display: flex; gap: 8px;">
                <button type="submit" class="btn" style="background: #1e293b; color: white; font-weight: 600; padding: 7px 14px; font-size: 13px; margin: 0; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);">Search</button>
                <a href="{% url 'dashboard' %}" class="btn" style="background: transparent; color: #64748b; font-weight: 600; padding: 7px 14px; font-size: 13px; margin: 0; border: 1.5px solid #cbd5e1; box-shadow: none;">Clear</a>
            </div>
        </div>

        {% if request.GET.search or request.GET.date_from or request.GET.date_to or request.GET.status %}
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: space-between;">
                <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                    <span style="font-size: 13px; color: var(--text-secondary); font-weight: 600;">Active Filters:</span>
                    {% if request.GET.search %}
                    <span class="badge" style="background: var(--info-light); color: #1e40af;">Search: "{{ request.GET.search }}"</span>
                    {% endif %}
                    {% if request.GET.date_from and request.GET.date_to %}
                    <span class="badge" style="background: var(--info-light); color: #1e40af;">Date Range: {{ request.GET.date_from }} to {{ request.GET.date_to }}</span>
                    {% elif request.GET.date_from %}
                    <span class="badge" style="background: var(--info-light); color: #1e40af;">Date From: {{ request.GET.date_from }}</span>
                    {% elif request.GET.date_to %}
                    <span class="badge" style="background: var(--info-light); color: #1e40af;">Date To: {{ request.GET.date_to }}</span>
                    {% endif %}
                    {% if request.GET.status %}
                    <span class="badge" style="background: var(--info-light); color: #1e40af;">Status: {{ request.GET.status }}</span>
                    {% endif %}
                </div>
                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: linear-gradient(135deg, var(--primary-light) 0%, #e2e8f0 100%); border-radius: 6px; border: 1px solid var(--border);">
                    <svg style="width: 16px; height: 16px; color: var(--primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    <span style="font-size: 13px; color: var(--dark); font-weight: 700;">{{ display_count }} {% if display_count == 1 %}trip{% else %}trips{% endif %}</span>
                </div>
            </div>
        </div>
        {% endif %}
    </form>

    {% if bookings %}
        <!-- Trip Count Display (shown even without filters) -->
        {% if not request.GET.search and not request.GET.date_from and not request.GET.date_to and not request.GET.status %}
        <div style="margin-bottom: 16px; display: flex; justify-content: flex-end;">
            <div style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: linear-gradient(135deg, var(--primary-light) 0%, #e2e8f0 100%); border-radius: 6px; border: 1px solid var(--border);">
                <svg style="width: 16px; height: 16px; color: var(--primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <span style="font-size: 13px; color: var(--dark); font-weight: 700;">Total: {{ display_count }} {% if display_count == 1 %}trip{% else %}trips{% endif %}</span>
            </div>
        </div>
        {% endif %}
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th class="sortable {% if sort_field == 'passenger' %}sort-{{ sort_order }}{% endif %}" data-sort="passenger">
                            Passenger
                            <span class="sort-icon"></span>
                        </th>
                        {% if is_admin %}
                        <th class="sortable hide-mobile {% if sort_field == 'customer' %}sort-{{ sort_order }}{% endif %}" data-sort="customer">
                            Customer
                            <span class="sort-icon"></span>
                        </th>
                        {% endif %}
                        <th>Pickup</th>
                        <th class="sortable {% if sort_field == 'datetime' %}sort-{{ sort_order }}{% endif %}" data-sort="datetime">
                            Date & Time
                            <span class="sort-icon"></span>
                        </th>
                        <th class="sortable hide-mobile {% if sort_field == 'vehicle' %}sort-{{ sort_order }}{% endif %}" data-sort="vehicle">
                            Vehicle
                            <span class="sort-icon"></span>
                        </th>
                        <th class="sortable {% if sort_field == 'status' %}sort-{{ sort_order }}{% endif %}" data-sort="status">
                            Status
                            <span class="sort-icon"></span>
                        </th>
                        {% if is_admin %}
                        <th class="sortable hide-mobile {% if sort_field == 'driver' %}sort-{{ sort_order }}{% endif %}" data-sort="driver">
                            Driver
                            <span class="sort-icon"></span>
                        </th>
                        {% endif %}
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in bookings %}
                    <tr class="booking-row-{{ booking.id }}" {% if booking.is_past_trip or booking.status == 'Cancelled' or booking.status == 'Cancelled_Full_Charge' %}style="opacity: 0.5; background-color: rgba(0,0,0,0.02); color: var(--text-muted);"{% endif %}>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-size: 10px; font-weight: 700; color: var(--primary); background: var(--primary-light); padding: 2px 6px; border-radius: 4px;">ID #{{ booking.id }}</span>
                                {% if not is_admin and booking.has_unviewed_changes %}
                                    <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 9px; font-weight: 700; color: #8b302b; background: #fef0ef; padding: 2px 6px; border-radius: 4px; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;" title="Recent activity - status updated">
                                        <svg style="width: 9px; height: 9px;" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"/>
                                        </svg>
                                        NEW
                                    </span>
                                {% endif %}
                                {% if booking.trip_type == 'Round' and booking.linked_booking %}
                                    <span class="round-trip-badge">
                                        <svg style="width: 12px; height: 12px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                                        </svg>
                                        ROUND
                                    </span>
                                {% endif %}
                            </div>
                            <div style="font-weight: 600; color: var(--dark);">
                                {{ booking.passenger_name }}
                                {% if booking.is_past_trip %}
                                    <span style="font-size: 10px; color: var(--text-muted); font-weight: 500; margin-left: 6px;">(Past Trip)</span>
                                {% endif %}
                                {% if booking.trip_label %}
                                    <span style="font-size: 10px; color: var(--text-secondary); font-weight: 500; margin-left: 6px;">({{ booking.trip_label }})</span>
                                {% endif %}
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary);">{{ booking.phone_number|default:booking.passenger_email }}</div>
                            {% if booking.booking_reference %}
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">{{ booking.booking_reference }}</div>
                            {% endif %}
                        </td>
                        {% if is_admin %}
                        <td class="hide-mobile">
                            <div style="font-weight: 500; color: var(--dark);">{{ booking.user.username }}</div>
                            {% if booking.user.profile.company_name %}
                            <div style="font-size: 11px; color: var(--primary); font-weight: 600; margin-top: 2px;">
                                <svg style="width: 11px; height: 11px; display: inline-block; vertical-align: middle; margin-right: 3px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>{{ booking.user.profile.company_name }}
                            </div>
                            {% endif %}
                            <div style="font-size: 12px; color: var(--text-secondary);">{{ booking.user.email|default:"No email" }}</div>
                        </td>
                        {% endif %}
                        <td>
                            <div style="font-size: 13px; color: var(--dark);">{{ booking.pick_up_address }}</div>
                            {% if booking.drop_off_address %}
                            <div style="font-size: 12px; color: var(--text-secondary);">→ {{ booking.drop_off_address }}</div>
                            {% endif %}
                        </td>
                        <td>
                            <div style="font-weight: 500;">{{ booking.pick_up_date }}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">{{ booking.pick_up_time }}</div>
                            {% if booking.hours_until_pickup > 0 and booking.hours_until_pickup <= 24 and booking.status in 'Pending,Confirmed' %}
                            <div style="font-size: 10px; color: var(--warning); font-weight: 600; margin-top: 4px;">
                                {{ booking.time_until_pickup_formatted }} away
                            </div>
                            {% endif %}
                        </td>
                        <td class="hide-mobile">
                            <div>{{ booking.vehicle_type }}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">{{ booking.get_trip_type_display }}</div>
                        </td>
                        <td>
                            <span class="badge badge-{{ booking.status|lower }}">
                                {% if booking.status == 'Confirmed' %}
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                    </svg>
                                {% elif booking.status == 'Pending' %}
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                {% elif booking.status == 'Trip_Completed' %}
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                {% elif booking.status == 'Cancelled' or booking.status == 'Cancelled_Full_Charge' %}
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                {% endif %}
                                {{ booking.get_status_display }}
                            </span>
                        </td>
                        {% if is_admin %}
                        <td class="hide-mobile">
                            {% if booking.assigned_driver %}
                                <div style="font-weight: 500; color: var(--dark);">{{ booking.assigned_driver.full_name }}</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">
                                    {% if booking.driver_response_status == 'accepted' %}
                                        <span style="color: #2e7d32;">✓ Accepted</span>
                                    {% elif booking.driver_response_status == 'rejected' %}
                                        <span style="color: #8b302b;">✗ Rejected</span>
                                    {% elif booking.driver_response_status == 'completed' %}
                                        <span style="color: #0c5460;">✓ Completed</span>
                                    {% endif %}
                                </div>
                            {% else %}
                                <span style="color: var(--text-muted); font-size: 12px;">Driver Not Assigned</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        <td>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                {% if booking.is_past_trip %}
                                    {# Past trips: Only show View and Rebook #}
                                    <a href="{% url 'reservation_detail' booking.id %}" class="action-link">View</a>
                                    <a href="{% url 'rebook_reservation' booking.id %}" class="action-link" style="color: var(--primary); font-weight: 600;">
                                        <svg style="width: 12px; height: 12px; display: inline-block; vertical-align: middle; margin-right: 2px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                        </svg>
                                        Rebook
                                    </a>
                                {% else %}
                                    {# Active trips: Normal actions #}
                                    {% if booking.trip_type == 'Round' and booking.linked_booking %}
                                        <button onclick="toggleReturn({{ booking.id }})" class="expand-btn expand-btn-{{ booking.id }}">
                                            <svg class="expand-icon expand-icon-{{ booking.id }}" style="transform: rotate(0deg);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                            </svg>
                                            Show Return
                                        </button>
                                    {% endif %}
                                    <a href="{% url 'reservation_detail' booking.id %}" class="action-link">
                                        <svg style="width: 12px; height: 12px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                        </svg>
                                        View
                                    </a>
                                    {% if is_admin %}
                                        {% if booking.status == 'Pending' %}
                                            <a href="{% url 'reservation_actions' booking.id 'confirm' %}" class="action-link action-approve">
                                                <svg style="width: 12px; height: 12px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                </svg>
                                                Approve
                                            </a>
                                        {% elif booking.status == 'Confirmed' %}
                                            {% if booking.hours_until_pickup <= 0 %}
                                                <a href="{% url 'reservation_actions' booking.id 'complete' %}" class="action-link action-complete">
                                                    <svg style="width: 12px; height: 12px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                    </svg>
                                                    Complete
                                                </a>
                                            {% else %}
                                                <span class="action-link" style="opacity: 0.4; cursor: not-allowed; pointer-events: none; background: #f3f4f6; color: #9ca3af;" title="Cannot complete until after pickup time ({{ booking.time_until_pickup_formatted }} remaining)">
                                                    <svg style="width: 12px; height: 12px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                                    </svg>
                                                    Complete
                                                </span>
                                            {% endif %}
                                        {% endif %}
                                    {% else %}
                                        {% if booking.status in 'Pending,Confirmed' and booking.hours_until_pickup > 2 %}
                                            <a href="{% url 'update_reservation' booking.id %}" class="action-link">
                                                <svg style="width: 12px; height: 12px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                </svg>
                                                Edit
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            </div>
                        </td>
                    </tr>

                    {% if booking.trip_type == 'Round' and booking.linked_booking %}
                    <tr class="return-row return-row-{{ booking.id }}" style="display: none;">
                        <td colspan="{% if is_admin %}7{% else %}6{% endif %}" style="padding: 16px 24px;">
                            <div class="return-trip-content">
                                <div style="font-weight: 600; color: var(--primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                    <svg style="width: 14px; height: 14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                                    </svg>
                                    Return Trip
                                    <span style="font-size: 10px; font-weight: 700; color: var(--primary); background: var(--primary-light); padding: 2px 6px; border-radius: 4px; margin-left: 4px;">ID #{{ booking.linked_booking.id }}</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">PASSENGER</div>
                                        <div style="font-weight: 500; color: var(--dark);">{{ booking.linked_booking.passenger_name }}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">{{ booking.linked_booking.phone_number|default:booking.linked_booking.passenger_email }}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">PICKUP</div>
                                        <div style="font-size: 13px; color: var(--dark);">{{ booking.linked_booking.pick_up_address }}</div>
                                        {% if booking.linked_booking.drop_off_address %}
                                        <div style="font-size: 12px; color: var(--text-secondary);">→ {{ booking.linked_booking.drop_off_address }}</div>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">DATE & TIME</div>
                                        <div style="font-weight: 500;">{{ booking.linked_booking.pick_up_date }}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">{{ booking.linked_booking.pick_up_time }}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">STATUS</div>
                                        <span class="badge badge-{{ booking.linked_booking.status|lower }}">{{ booking.linked_booking.get_status_display }}</span>
                                    </div>
                                    {% if is_admin %}
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">DRIVER</div>
                                        {% if booking.linked_booking.assigned_driver %}
                                            <div style="font-weight: 500; color: var(--dark);">{{ booking.linked_booking.assigned_driver.full_name }}</div>
                                            <div style="font-size: 12px; color: var(--text-secondary);">{{ booking.linked_booking.assigned_driver.car_type }}</div>
                                        {% else %}
                                            <span style="color: var(--text-muted); font-size: 12px;">Not assigned</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    <div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">ACTIONS</div>
                                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                            <a href="{% url 'reservation_detail' booking.linked_booking.id %}" class="action-link">View</a>
                                            {% if is_admin %}
                                                <a href="{% url 'assign_driver' booking.linked_booking.id %}" class="action-link">Assign Driver</a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if page_obj.has_other_pages %}
        <div style="margin-top: 24px; display: flex; justify-content: center; align-items: center; gap: 16px; flex-wrap: wrap;">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.upcoming %}&upcoming={{ request.GET.upcoming }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}{% if sort_field %}&sort={{ sort_field }}&order={{ sort_order }}{% endif %}" class="btn btn-secondary">← Previous</a>
            {% endif %}

            <span style="color: var(--text-secondary);">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.upcoming %}&upcoming={{ request.GET.upcoming }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}{% if sort_field %}&sort={{ sort_field }}&order={{ sort_order }}{% endif %}" class="btn btn-secondary">Next →</a>
            {% endif %}
        </div>
        {% endif %}
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <svg style="width: 36px; height: 36px; color: var(--border-dark);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
            </div>
            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--dark);">No bookings yet</h3>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Rotate between multiple trips at the same time (if any)
let currentTripIndex = 0;
let tripRotationInterval = null;

function rotateNextReservationTrips() {
    const tripItems = document.querySelectorAll('.trip-rotation-item');
    if (tripItems.length <= 1) return; // No rotation needed for single trip
    
    const counter = document.getElementById('trip-counter');
    const container = document.querySelector('.stat-card.next-reservation-card');
    
    function showTrip(index) {
        // Fade out current trip
        tripItems.forEach((item, i) => {
            if (i === currentTripIndex) {
                item.style.opacity = '0';
                setTimeout(() => {
                    item.style.display = 'none';
                }, 500);
            }
        });
        
        // Update index
        currentTripIndex = index;
        
        // Fade in next trip
        setTimeout(() => {
            const nextItem = tripItems[currentTripIndex];
            nextItem.style.display = 'flex';
            setTimeout(() => {
                nextItem.style.opacity = '1';
            }, 50);
            
            // Update counter
            if (counter) {
                counter.textContent = `${currentTripIndex + 1}/${tripItems.length}`;
            }
            
            // Update click handler to go to correct trip
            const tripId = nextItem.dataset.tripId;
            if (container && tripId) {
                container.onclick = function() {
                    window.location.href = `/bookings/${tripId}/`;
                };
            }
            
            // Update countdowns for this trip
            updateAllCountdowns();
        }, 500);
    }
    
    function rotateToNext() {
        const nextIndex = (currentTripIndex + 1) % tripItems.length;
        showTrip(nextIndex);
    }
    
    // Start rotation every 3 seconds
    tripRotationInterval = setInterval(rotateToNext, 3000);
}

// Live countdown for next reservation (when < 24 hours)
// Updated to handle multiple countdowns (for rotation)
// IMPORTANT: All times are in America/Chicago timezone
function updateAllCountdowns() {
    const countdownElements = document.querySelectorAll('.live-countdown');
    
    countdownElements.forEach(countdownElement => {
        const pickupDate = countdownElement.dataset.pickupDate;
        const pickupTime = countdownElement.dataset.pickupTime;
        
        if (!pickupDate || !pickupTime) return;
        
        // Create pickup datetime in Chicago timezone
        const pickupDateTimeString = `${pickupDate}T${pickupTime}`;
        
        // Get current time in Chicago timezone
        const now = new Date();
        const chicagoTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Chicago' }));
        
        // Parse pickup time as Chicago time
        const pickupLocal = new Date(pickupDateTimeString);
        const pickupChicago = new Date(pickupLocal.toLocaleString('en-US', { timeZone: 'America/Chicago' }));
        
        // Calculate the difference between Chicago time and what the browser interpreted
        const offset = pickupLocal - pickupChicago;
        
        // Adjust pickup time to be correctly interpreted as Chicago time
        const pickupCorrected = new Date(pickupLocal.getTime() - offset);
        
        // Calculate difference
        const diff = pickupCorrected - now;
        
        if (diff <= 0) {
            countdownElement.textContent = 'PICKUP TIME';
            countdownElement.parentElement.style.background = '#fee2e2';
            countdownElement.parentElement.style.color = '#991b1b';
            return;
        }
        
        const totalSeconds = Math.floor(diff / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        
        countdownElement.textContent = `${hours}h ${minutes}m ${seconds}s`;
        
        // Update color based on urgency
        if (hours < 2) {
            countdownElement.parentElement.style.background = '#fee2e2';
            countdownElement.parentElement.style.color = '#991b1b';
        } else if (hours < 6) {
            countdownElement.parentElement.style.background = '#fef9e7';
            countdownElement.parentElement.style.color = '#8b6914';
        }
    });
}

// Legacy function for backward compatibility (single countdown)
function updateLiveCountdown() {
    updateAllCountdowns();
}

// Initialize rotation and countdowns on page load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        rotateNextReservationTrips();
        updateAllCountdowns();
        // Update countdowns every second
        setInterval(updateAllCountdowns, 1000);
    });
} else {
    rotateNextReservationTrips();
    updateAllCountdowns();
    // Update countdowns every second
    setInterval(updateAllCountdowns, 1000);
}

function toggleReturn(bookingId) {
    const returnRow = document.querySelector('.return-row-' + bookingId);
    const expandIcon = document.querySelector('.expand-icon-' + bookingId);
    const expandBtn = document.querySelector('.expand-btn-' + bookingId);

    // Toggle between shown and hidden states
    if (returnRow.style.display === 'table-row') {
        returnRow.style.display = 'none';
        expandIcon.style.transform = 'rotate(0deg)';
        expandBtn.innerHTML = expandBtn.innerHTML.replace('Hide Return', 'Show Return');
    } else {
        returnRow.style.display = 'table-row';
        expandIcon.style.transform = 'rotate(180deg)';
        expandBtn.innerHTML = expandBtn.innerHTML.replace('Show Return', 'Hide Return');
    }
}

// Column sorting functionality
document.querySelectorAll('.sortable').forEach(header => {
    header.addEventListener('click', function() {
        const sortField = this.dataset.sort;
        const currentOrder = this.classList.contains('sort-asc') ? 'desc' : 'asc';
        
        // Build URL with sort parameters and preserve existing filters
        const url = new URL(window.location);
        url.searchParams.set('sort', sortField);
        url.searchParams.set('order', currentOrder);
        
        window.location = url.toString();
    });
});
</script>
{% endblock %}